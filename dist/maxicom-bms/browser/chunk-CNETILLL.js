import{a as M}from"./chunk-L26O6Y2M.js";import{r as B,s as E,t as G}from"./chunk-4PO2YNOU.js";import{B as S,F as C,T as h,W as I,Z as A,ca as L,g as V,k as p,l as $,p as m,v as _,x as T,z as R}from"./chunk-OB35JHSB.js";import{a as b,b as U}from"./chunk-C6Q5SG76.js";var f=[];for(let u=0;u<256;++u)f.push((u+256).toString(16).slice(1));function x(u,t=0){return(f[u[t+0]]+f[u[t+1]]+f[u[t+2]]+f[u[t+3]]+"-"+f[u[t+4]]+f[u[t+5]]+"-"+f[u[t+6]]+f[u[t+7]]+"-"+f[u[t+8]]+f[u[t+9]]+"-"+f[u[t+10]]+f[u[t+11]]+f[u[t+12]]+f[u[t+13]]+f[u[t+14]]+f[u[t+15]]).toLowerCase()}var O,w=new Uint8Array(16);function D(){if(!O){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");O=crypto.getRandomValues.bind(crypto)}return O(w)}var H=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),N={randomUUID:H};function j(u,t,e){u=u||{};let i=u.random??u.rng?.()??D();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,t){if(e=e||0,e<0||e+16>t.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let r=0;r<16;++r)t[e+r]=i[r];return t}return x(i)}function q(u,t,e){return N.randomUUID&&!t&&!u?N.randomUUID():j(u,t,e)}var y=q;var F=class u{constructor(t,e){this.http=t;this.configService=e;this.serialPortDefinitions=this.configService.serialPorts,this.loadStringsFromStorage(),this.stringsLoadedSubject.next(!1),this.loadStringsFromApi()}BASE_URL="/rest";latestValueApiUrl="/rest/latest-value";STORAGE_KEY="maxicom-strings-config";MAX_STRING_SCAN=12;stringsState=[];isLoadingFromApi=!1;stringsLoadedSubject=new V(!1);serialPortDefinitions=[];loadStringsFromStorage(){try{let t=localStorage.getItem(this.STORAGE_KEY);t&&(this.stringsState=JSON.parse(t))}catch(t){console.error("Error reading String config from localStorage",t),this.stringsState=[]}}fetchStringDetailFromLatestValue(t){let e=new B().set("stringID",t.toString());return this.http.get(`${this.latestValueApiUrl}/string`,{params:e}).pipe(m(i=>i?.success?i.data:null),S(i=>(i instanceof E&&i.status!==400&&console.warn(`[Strings] Latest-value string API failed for stringId=${t}`,i),p(null))))}buildStringIndicesToCheck(t=!1){let e=this.stringsState.map(i=>i.stringIndex);if(t){let i=Array.from({length:this.MAX_STRING_SCAN},(n,a)=>a+1);return Array.from(new Set([...e,...i])).filter(n=>n>0).sort((n,a)=>n-a)}return e.filter(i=>i>0).sort((i,r)=>i-r)}hasStringDetail(t){return t?!!(t.stringName&&t.stringName.trim().length>0||t.cellBrand&&t.cellBrand.trim().length>0||t.cellModel&&t.cellModel.trim().length>0||typeof t.cellQty=="number"||typeof t.cNominal=="number"||typeof t.vCutoff=="number"||typeof t.vFloat=="number"):!1}mapLatestValueDtoToBatteryString(t,e,i,r){let n=(a,l)=>{if(a==null)return l??0;let s=Number(a);return Number.isFinite(s)?s:l??0};return{id:r?.id||y(),stringIndex:i,stringName:t.stringName?.trim()||r?.stringName||e,cellQty:n(t.cellQty,r?.cellQty),cellBrand:t.cellBrand??r?.cellBrand??"",cellModel:t.cellModel??r?.cellModel??"",ratedCapacity:n(t.cNominal,r?.ratedCapacity),cutoffVoltage:n(t.vCutoff,r?.cutoffVoltage),floatVoltage:n(t.vFloat,r?.floatVoltage),serialPortId:t.serialPortId??r?.serialPortId??""}}saveStringsToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.stringsState))}loadStringsFromApi(t=!1){if(this.isLoadingFromApi)return;this.isLoadingFromApi=!0,(t?this.getStringIndicesFromOpenMUC().pipe(m(i=>i.filter(r=>r>0).sort((r,n)=>r-n)),S(i=>(console.warn("[Strings] Failed to get devices from OpenMUC, using cache indices:",i),p(this.buildStringIndicesToCheck(t))))):p(this.buildStringIndicesToCheck(t))).pipe(h(i=>{if(i.length===0)return t&&(this.stringsState=[],this.saveStringsToStorage()),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),p([]);let r=new Map(this.stringsState.map(l=>[l.stringIndex,l])),n=t?new Set(i):null,a=i.map(l=>this.fetchStringDetailFromLatestValue(l).pipe(m(s=>({index:l,dto:s,source:"latest-value"})),S(s=>(s instanceof E&&s.status!==400&&console.warn(`[Strings] Failed to load latest-value for str${l}:`,s),p({index:l,dto:null,source:"latest-value"})))));return _(a).pipe(h(l=>{let s=l.filter(o=>!o.dto||!this.hasStringDetail(o.dto)).map(o=>o.index);if(s.length===0)return p(l);let d=s.map(o=>this.fetchStringDetailFromOpenMUC(o).pipe(m(g=>({index:o,dto:g,source:"openmuc"})),S(()=>p({index:o,dto:null,source:"openmuc"}))));return _(d).pipe(m(o=>{let g=new Map;return l.forEach(c=>g.set(c.index,c)),o.forEach(c=>{(!g.has(c.index)||!g.get(c.index)?.dto)&&g.set(c.index,c)}),Array.from(g.values())}))}),m(l=>{let s=new Map;l.forEach(({index:o,dto:g})=>{if(n&&!n.has(o))return;let c=r.get(o);if(g&&this.hasStringDetail(g)){let v=`str${o}`,P=this.mapLatestValueDtoToBatteryString(g,v,o,c);s.set(o,P)}else c&&!t&&s.set(o,c)}),t||r.forEach((o,g)=>{s.has(g)||s.set(g,o)});let d=Array.from(s.values()).sort((o,g)=>o.stringIndex-g.stringIndex);return this.stringsState=d,this.saveStringsToStorage(),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),d}))}),S(i=>(console.error("Error in loadStringsFromApi (latest-value mode):",i),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),p([])))).subscribe()}getStringIndicesFromOpenMUC(){return this.http.get(`${this.BASE_URL}/devices`).pipe(m(t=>{let e=[],i=/^str(\d+)_(modbus|virtual)$/;return t.devices?.forEach(r=>{let n=r.match(i);if(n){let a=parseInt(n[1],10);!isNaN(a)&&!e.includes(a)&&e.push(a)}}),e.sort((r,n)=>r-n)}),S(t=>(console.warn("[Strings] Failed to get devices from OpenMUC:",t),p([]))))}fetchStringDetailFromOpenMUC(t){let i=[`str${t}_string_name`,`str${t}_cell_qty`,`str${t}_cell_brand`,`str${t}_cell_model`,`str${t}_Cnominal`,`str${t}_Vnominal`].map(r=>this.http.get(`${this.BASE_URL}/channels/${r}`).pipe(m(n=>{let a=n?.record?.value;return{channel:r,value:a}}),S(()=>p({channel:r,value:null}))));return _(i).pipe(m(r=>{let n={};return r.forEach(({channel:a,value:l})=>{l!=null&&(a.includes("string_name")?n.stringName=String(l):a.includes("cell_qty")?n.cellQty=Number(l):a.includes("cell_brand")?n.cellBrand=String(l):a.includes("cell_model")?n.cellModel=String(l):a.includes("Cnominal")?n.cNominal=Number(l):a.includes("Vcutoff")?n.vCutoff=Number(l):a.includes("Vfloat")?n.vFloat=Number(l):a.includes("serial_port_id")&&(n.serialPortId=String(l)))}),this.hasStringDetail(n)?n:null}),S(()=>p(null)))}getStrings(){return this.stringsLoadedSubject.pipe(R(t=>t),m(()=>[...this.stringsState]),C(1))}reloadStrings(){return this.stringsLoadedSubject.next(!1),this.isLoadingFromApi=!1,this.loadStringsFromApi(!0),this.stringsLoadedSubject.pipe(R(t=>t),m(()=>[...this.stringsState]),C(1))}getStringById(t){let e=this.stringsState.find(i=>i.id===t);return p(e)}deleteString(t){let e=this.stringsState.find(a=>a.id===t);if(!e)return $(()=>new Error("String Config not found"));let i=e.stringIndex,r=this.apiDelete(`/devices_v2/str${i}_modbus`),n=this.apiDelete(`/devices_v2/str${i}_virtual`);return _([r,n]).pipe(h(()=>{let a=`${this.latestValueApiUrl}/delete-string?stringId=${i}`;return this.http.post(a,null).pipe(m(()=>({success:!0})),S(l=>l instanceof E&&l.status===400?p({success:!0}):(console.warn(`[Strings] Failed to delete metadata for str${i}`,l),p({success:!1,error:l}))))}),I(()=>{this.stringsState=this.stringsState.filter(a=>a.id!==t),this.saveStringsToStorage(),this.stringsLoadedSubject.next(!0)}),h(()=>p(null)))}addString(t,e){return this.getStrings().pipe(h(i=>{this.stringsState=i;let n=this.stringsState.reduce((l,s)=>Math.max(l,s.stringIndex),0)+1,a=U(b({},t),{id:y(),stringIndex:n});return this.checkDeviceExists(n).pipe(h(l=>l?$(()=>new Error(`String ${n} already exists on OpenMUC. Please reload the page.`)):this.createStringApi(n,t,e).pipe(I(()=>{this.stringsState.push(a),this.saveStringsToStorage(),this.stringsLoadedSubject.next(!0)}),h(()=>T(2e3).pipe(h(()=>this.fetchStringDetailFromLatestValue(n).pipe(m(s=>s&&this.hasStringDetail(s)?this.mapLatestValueDtoToBatteryString(s,`str${n}`,n,a):a),S(()=>p(a)))))),I(s=>{let d=this.stringsState.findIndex(o=>o.id===a.id);d>=0&&(this.stringsState[d]=s,this.saveStringsToStorage())}),m(()=>a))))}))}checkDeviceExists(t){let e=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_modbus`).pipe(m(()=>!0),S(r=>r instanceof E&&r.status===404?p(!1):p(!1))),i=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_virtual`).pipe(m(()=>!0),S(r=>r instanceof E&&r.status===404?p(!1):p(!1)));return _([e,i]).pipe(m(([r,n])=>r||n))}updateString(t,e,i){let r=this.stringsState.find(s=>s.id===t);if(!r)return $(()=>new Error("String Config not found"));let n=r.stringIndex,a=this.apiDelete(`/devices_v2/str${n}_modbus`),l=this.apiDelete(`/devices_v2/str${n}_virtual`);return _([a,l]).pipe(h(()=>this.createStringApi(n,e,i)),I(()=>{let s=b(b({},r),e);this.stringsState=this.stringsState.map(d=>d.id===t?s:d),this.saveStringsToStorage()}))}createStringApi(t,e,i){let r=this.buildModbusPayload(t,e.cellQty,i),n=this.buildVirtualPayload(t,e.cellQty),a=this.apiPost(`/devices_v2/str${t}_modbus`,r),l=this.apiPost(`/devices_v2/str${t}_virtual`,n);return _([a,l]).pipe(h(()=>T(2e3)),h(()=>{let s=[this.apiPutChannel(`str${t}_string_name`,e.stringName),this.apiPutChannel(`str${t}_cell_qty`,e.cellQty),this.apiPutChannel(`str${t}_cell_brand`,e.cellBrand),this.apiPutChannel(`str${t}_cell_model`,e.cellModel),this.apiPutChannel(`str${t}_Cnominal`,e.ratedCapacity),this.apiPutChannel(`str${t}_Vcutoff`,e.cutoffVoltage),this.apiPutChannel(`str${t}_Vfloat`,e.floatVoltage),this.apiPutChannel(`str${t}_serial_port_id`,e.serialPortId)];return _(s)}))}buildModbusPayload(t,e,i){let r=this.buildModbusSettings(i),n=[],a=1e4,l=(s,d=50)=>(s-1)%20*d;for(let s=1;s<=e;s++){let d=`str${t}_cell${s}`,o=`str${t}_sg_slave_${s}`,g=l(s),c={samplingInterval:12e3,samplingGroup:o,samplingTimeOffset:g,disabled:!1};n.push(b({id:`${d}_R`,description:`Cell (R) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:1:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1e3+(t-1)*a+s*2}:INTEGER`}]},c)),n.push(b({id:`${d}_V`,description:`Cell (V) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:2:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1300+(t-1)*a+s*2}:INTEGER`}]},c)),n.push(b({id:`${d}_T`,description:`Cell (T) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:3:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1600+(t-1)*a+s*2}:INTEGER`}]},c))}return n.push({id:`str${t}_total_I`,description:`String ${t} (I)`,channelAddress:"206:HOLDING_REGISTERS:0:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1900+(t-1)*a+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:8e3,loggingSettings:"sqllogger:",samplingGroup:`str${t}_sg_pack`,samplingTimeOffset:l(206),disabled:!1}),n.push({id:`str${t}_ambient_T`,description:`String ${t} (T ambient)`,channelAddress:"1:HOLDING_REGISTERS:2:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${2100+(t-1)*a+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:8e3,loggingSettings:"sqllogger:",samplingTimeOffset:l(106),disabled:!1}),{driver:"modbus",configs:{id:`str${t}_modbus`,description:`String ${t} Modbus RTU`,deviceAddress:i.port,settings:r,samplingTimeout:15e3,connectRetryInterval:15e3,disabled:!1},channels:n}}buildVirtualPayload(t,e){let i=[],r=(s,d,o,g,c)=>{let v={id:s,description:o,valueType:d,disabled:!1};g&&(v.unit=g),d.toUpperCase()==="STRING"&&(v.valueTypeLength=c||64),i.push(v)},n=(s,d,o,g)=>{let c={id:s,description:o,valueType:d,disabled:!1};g&&(c.unit=g);let v=s.toUpperCase();v.includes("STRING_SOC")||v.includes("STRING_SOH")?(c.loggingInterval=6e4,c.loggingSettings="sqllogger:"):v.includes("_SOC")||v.includes("_SOH"),i.push(c)},a=(s,d,o,g)=>{let c={id:s,description:o,valueType:d,disabled:!1};g&&(c.unit=g),i.push(c)};r(`str${t}_cell_qty`,"INTEGER","number of cells"),r(`str${t}_Cnominal`,"DOUBLE","C nominal","Ah"),r(`str${t}_string_name`,"STRING","String name",void 0,64),r(`str${t}_cell_brand`,"STRING","Cell Brand",void 0,64),r(`str${t}_cell_model`,"STRING","Cell Model",void 0,64),r(`str${t}_Vcutoff`,"DOUBLE","V cutoff","V"),r(`str${t}_Vfloat`,"DOUBLE","V cutoff","V"),r(`str${t}_serial_port_id`,"STRING","Serial port ID",void 0,64);let l=[[`str${t}_string_vol`,"DOUBLE","String Voltage","V"],[`str${t}_max_voltage_cell_id`,"INTEGER","Max V Cell ID",void 0],[`str${t}_min_voltage_cell_id`,"INTEGER","Min V Cell ID",void 0],[`str${t}_max_temp_cell_id`,"INTEGER","Max T Cell ID",void 0],[`str${t}_min_temp_cell_id`,"INTEGER","Min T Cell ID",void 0],[`str${t}_max_rst_cell_id`,"INTEGER","Max R Cell ID",void 0],[`str${t}_min_rst_cell_id`,"INTEGER","Min R Cell ID",void 0],[`str${t}_average_vol`,"DOUBLE","Average Cell Voltage","V"],[`str${t}_average_temp`,"DOUBLE","Average Cell Temperature","C"],[`str${t}_average_rst`,"DOUBLE","Average Cell R","miliOhm"],[`str${t}_max_voltage_value`,"DOUBLE","Max Cell Voltage","V"],[`str${t}_min_voltage_value`,"DOUBLE","Min Cell Voltage","V"],[`str${t}_max_temp_value`,"DOUBLE","Max Cell Temperature","C"],[`str${t}_min_temp_value`,"DOUBLE","Min Cell Temperature","C"],[`str${t}_max_rst_value`,"DOUBLE","Max Cell Internal Resistance","miliOhm"],[`str${t}_min_rst_value`,"DOUBLE","Min Cell Internal Resistance","miliOhm"],[`str${t}_string_SOC`,"DOUBLE","String SoC","%"],[`str${t}_string_SOH`,"DOUBLE","String SoH","%"]];for(let[s,d,o,g]of l)n(s,d,o,g);for(let s=1;s<=e;s++){let d=`str${t}_cell${s}`;a(`${d}_SOC`,"DOUBLE","State of Charge","%"),a(`${d}_SOH`,"DOUBLE","State of Health","%")}return{driver:"virtual",configs:{id:`str${t}_virtual`,description:`String ${t} calculated channels`,disabled:!1},channels:i}}buildModbusSettings(t){let e=t.stopBits.toString().replace(".","_");return`RTU:SERIAL_ENCODING_RTU:${t.baudRate}:DATABITS_${t.dataBits}:${t.parity}:STOPBITS_${e}:ECHO_FALSE:FLOWCONTROL_NONE:FLOWCONTROL_NONE`}apiPost(t,e){return this.http.post(`${this.BASE_URL}${t}`,e).pipe(S(this.handleError))}apiDelete(t){return this.http.delete(`${this.BASE_URL}${t}`).pipe(S(e=>e.status===404?p(null):this.handleError(e)))}apiPutChannel(t,e){let i=`/channels/${t}`,r={record:{flag:"VALID",value:e}};return this.http.put(`${this.BASE_URL}${i}`,r).pipe(S(this.handleError))}handleError(t){let e="Unknown error";return t.error instanceof ErrorEvent?e=`Client Error: ${t.error.message}`:(e=`Server Error (Code: ${t.status}): ${t.message}`,t.error&&typeof t.error=="string"?e+=` - ${t.error}`:t.error&&t.error.detail&&(e+=` - ${t.error.detail}`)),console.error(e),$(()=>new Error(e))}static \u0275fac=function(e){return new(e||u)(L(G),L(M))};static \u0275prov=A({token:u,factory:u.\u0275fac,providedIn:"root"})};export{F as a};
