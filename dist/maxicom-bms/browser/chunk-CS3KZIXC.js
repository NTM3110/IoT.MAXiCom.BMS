import{a as G}from"./chunk-QAKHC542.js";import{q as M,r as I,s as B}from"./chunk-7DJ2AMDO.js";import{B as h,F as R,T as f,W as E,Z as U,ca as L,g as A,k as c,l as b,p as m,v,x as $,z as T}from"./chunk-4XLDPXVN.js";import{a as _,b as N}from"./chunk-C6Q5SG76.js";var S=[];for(let u=0;u<256;++u)S.push((u+256).toString(16).slice(1));function x(u,t=0){return(S[u[t+0]]+S[u[t+1]]+S[u[t+2]]+S[u[t+3]]+"-"+S[u[t+4]]+S[u[t+5]]+"-"+S[u[t+6]]+S[u[t+7]]+"-"+S[u[t+8]]+S[u[t+9]]+"-"+S[u[t+10]]+S[u[t+11]]+S[u[t+12]]+S[u[t+13]]+S[u[t+14]]+S[u[t+15]]).toLowerCase()}var D,w=new Uint8Array(16);function O(){if(!D){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");D=crypto.getRandomValues.bind(crypto)}return D(w)}var H=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),C={randomUUID:H};function j(u,t,e){u=u||{};let r=u.random??u.rng?.()??O();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){if(e=e||0,e<0||e+16>t.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let n=0;n<16;++n)t[e+n]=r[n];return t}return x(r)}function q(u,t,e){return C.randomUUID&&!t&&!u?C.randomUUID():j(u,t,e)}var y=q;var V=class u{constructor(t,e){this.http=t;this.configService=e;this.serialPortDefinitions=this.configService.serialPorts,this.loadStringsFromStorage(),this.stringsLoadedSubject.next(!1),this.loadStringsFromApi()}BASE_URL="/api";latestValueApiUrl="/api/latest-value";STORAGE_KEY="maxicom-strings-config";MAX_STRING_SCAN=12;stringsState=[];isLoadingFromApi=!1;stringsLoadedSubject=new A(!1);serialPortDefinitions=[];loadStringsFromStorage(){try{let t=localStorage.getItem(this.STORAGE_KEY);t&&(this.stringsState=JSON.parse(t))}catch(t){console.error("Error reading String config from localStorage",t),this.stringsState=[]}}fetchStringDetailFromLatestValue(t){let e=new M().set("stringId",t.toString());return this.http.get(`${this.latestValueApiUrl}/string`,{params:e}).pipe(m(r=>r?.success?r.data:null),h(r=>(r instanceof I&&r.status!==400&&console.warn(`[Strings] Latest-value string API failed for stringId=${t}`,r),c(null))))}buildStringIndicesToCheck(t=!1){let e=this.stringsState.map(r=>r.stringIndex);if(t){let r=Array.from({length:this.MAX_STRING_SCAN},(i,l)=>l+1);return Array.from(new Set([...e,...r])).filter(i=>i>0).sort((i,l)=>i-l)}return e.filter(r=>r>0).sort((r,n)=>r-n)}hasStringDetail(t){return t?!!(t.stringName&&t.stringName.trim().length>0||t.cellBrand&&t.cellBrand.trim().length>0||t.cellModel&&t.cellModel.trim().length>0||typeof t.cellQty=="number"||typeof t.cnominal=="number"||typeof t.vnominal=="number"):!1}mapLatestValueDtoToBatteryString(t,e,r,n){let i=(l,a)=>{if(l==null)return a??0;let s=Number(l);return Number.isFinite(s)?s:a??0};return{id:n?.id||y(),stringIndex:r,stringName:t.stringName?.trim()||n?.stringName||e,cellQty:i(t.cellQty,n?.cellQty),cellBrand:t.cellBrand??n?.cellBrand??"",cellModel:t.cellModel??n?.cellModel??"",ratedCapacity:i(t.cnominal,n?.ratedCapacity),nominalVoltage:i(t.vnominal,n?.nominalVoltage),serialPortId:n?.serialPortId||""}}saveStringsToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.stringsState))}loadStringsFromApi(t=!1){if(this.isLoadingFromApi)return;this.isLoadingFromApi=!0,(t?this.getStringIndicesFromOpenMUC().pipe(m(r=>r.filter(n=>n>0).sort((n,i)=>n-i)),h(r=>(console.warn("[Strings] Failed to get devices from OpenMUC, using cache indices:",r),c(this.buildStringIndicesToCheck(t))))):c(this.buildStringIndicesToCheck(t))).pipe(f(r=>{if(r.length===0)return t&&(this.stringsState=[],this.saveStringsToStorage()),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),c([]);let n=new Map(this.stringsState.map(a=>[a.stringIndex,a])),i=t?new Set(r):null,l=r.map(a=>this.fetchStringDetailFromLatestValue(a).pipe(m(s=>({index:a,dto:s,source:"latest-value"})),h(s=>(s instanceof I&&s.status!==400&&console.warn(`[Strings] Failed to load latest-value for str${a}:`,s),c({index:a,dto:null,source:"latest-value"})))));return v(l).pipe(f(a=>{let s=a.filter(o=>!o.dto||!this.hasStringDetail(o.dto)).map(o=>o.index);if(s.length===0)return c(a);let d=s.map(o=>this.fetchStringDetailFromOpenMUC(o).pipe(m(g=>({index:o,dto:g,source:"openmuc"})),h(()=>c({index:o,dto:null,source:"openmuc"}))));return v(d).pipe(m(o=>{let g=new Map;return a.forEach(p=>g.set(p.index,p)),o.forEach(p=>{(!g.has(p.index)||!g.get(p.index)?.dto)&&g.set(p.index,p)}),Array.from(g.values())}))}),m(a=>{let s=new Map;a.forEach(({index:o,dto:g})=>{if(i&&!i.has(o))return;let p=n.get(o);if(g&&this.hasStringDetail(g)){let F=`str${o}`,P=this.mapLatestValueDtoToBatteryString(g,F,o,p);s.set(o,P)}else p&&!t&&s.set(o,p)}),t||n.forEach((o,g)=>{s.has(g)||s.set(g,o)});let d=Array.from(s.values()).sort((o,g)=>o.stringIndex-g.stringIndex);return this.stringsState=d,this.saveStringsToStorage(),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),d}))}),h(r=>(console.error("Error in loadStringsFromApi:",r),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),c([])))).subscribe()}getStringIndicesFromOpenMUC(){return this.http.get(`${this.BASE_URL}/devices`).pipe(m(t=>{let e=[],r=/^str(\d+)_(modbus|virtual)$/;return t.devices?.forEach(n=>{let i=n.match(r);if(i){let l=parseInt(i[1],10);!isNaN(l)&&!e.includes(l)&&e.push(l)}}),e.sort((n,i)=>n-i)}),h(t=>(console.warn("[Strings] Failed to get devices from OpenMUC:",t),c([]))))}fetchStringDetailFromOpenMUC(t){let r=[`str${t}_string_name`,`str${t}_cell_qty`,`str${t}_cell_brand`,`str${t}_cell_model`,`str${t}_Cnominal`,`str${t}_Vnominal`].map(n=>this.http.get(`${this.BASE_URL}/channels/${n}`).pipe(m(i=>({channel:n,value:i?.record?.value})),h(()=>c({channel:n,value:null}))));return v(r).pipe(m(n=>{let i={};return n.forEach(({channel:l,value:a})=>{a!=null&&(l.includes("string_name")?i.stringName=String(a):l.includes("cell_qty")?i.cellQty=Number(a):l.includes("cell_brand")?i.cellBrand=String(a):l.includes("cell_model")?i.cellModel=String(a):l.includes("Cnominal")?i.cnominal=Number(a):l.includes("Vnominal")&&(i.vnominal=Number(a)))}),this.hasStringDetail(i)?i:null}),h(()=>c(null)))}getStrings(){return this.stringsLoadedSubject.pipe(T(t=>t),m(()=>[...this.stringsState]),R(1))}reloadStrings(){return this.stringsLoadedSubject.next(!1),this.isLoadingFromApi=!1,this.loadStringsFromApi(!0),this.stringsLoadedSubject.pipe(T(t=>t),m(()=>[...this.stringsState]),R(1))}getStringById(t){let e=this.stringsState.find(r=>r.id===t);return c(e)}deleteString(t){let e=this.stringsState.find(l=>l.id===t);if(!e)return b(()=>new Error("String Config not found"));let r=e.stringIndex,n=this.apiDelete(`/devices_v2/str${r}_modbus`),i=this.apiDelete(`/devices_v2/str${r}_virtual`);return v([n,i]).pipe(f(()=>{let l=`${this.latestValueApiUrl}/delete-string?stringId=${r}`;return this.http.post(l,null).pipe(m(()=>({success:!0})),h(a=>a instanceof I&&a.status===400?c({success:!0}):c({success:!1,error:a})))}),E(()=>{this.stringsState=this.stringsState.filter(l=>l.id!==t),this.saveStringsToStorage()}),f(()=>(this.loadStringsFromApi(),$(500).pipe(m(()=>null)))))}addString(t,e){return this.getStrings().pipe(f(r=>{this.stringsState=r;let i=this.stringsState.reduce((a,s)=>Math.max(a,s.stringIndex),0)+1,l=N(_({},t),{id:y(),stringIndex:i});return this.checkDeviceExists(i).pipe(f(a=>a?b(()=>new Error(`String ${i} already exists on OpenMUC.`)):this.createStringApi(i,t,e).pipe(E(()=>{this.stringsState.push(l),this.saveStringsToStorage(),this.stringsLoadedSubject.next(!0)}),f(()=>$(2e3).pipe(f(()=>this.fetchStringDetailFromLatestValue(i).pipe(m(s=>s&&this.hasStringDetail(s)?this.mapLatestValueDtoToBatteryString(s,`str${i}`,i,l):l),h(()=>c(l)))))),E(s=>{let d=this.stringsState.findIndex(o=>o.id===l.id);d>=0&&(this.stringsState[d]=s,this.saveStringsToStorage())}),m(()=>l))))}))}checkDeviceExists(t){let e=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_modbus`).pipe(m(()=>!0),h(()=>c(!1))),r=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_virtual`).pipe(m(()=>!0),h(()=>c(!1)));return v([e,r]).pipe(m(([n,i])=>n||i))}updateString(t,e,r){let n=this.stringsState.find(s=>s.id===t);if(!n)return b(()=>new Error("String Config not found"));let i=n.stringIndex,l=this.apiDelete(`/devices_v2/str${i}_modbus`),a=this.apiDelete(`/devices_v2/str${i}_virtual`);return v([l,a]).pipe(f(()=>this.createStringApi(i,e,r)),E(()=>{let s=_(_({},n),e);this.stringsState=this.stringsState.map(d=>d.id===t?s:d),this.saveStringsToStorage()}))}createStringApi(t,e,r){let n=this.buildModbusPayload(t,e.cellQty,r),i=this.buildVirtualPayload(t,e.cellQty),l=this.apiPost(`/devices_v2/str${t}_modbus`,n),a=this.apiPost(`/devices_v2/str${t}_virtual`,i);return v([l,a]).pipe(f(()=>$(2e3)),f(()=>{let s=[this.apiPutChannel(`str${t}_string_name`,e.stringName),this.apiPutChannel(`str${t}_cell_qty`,e.cellQty),this.apiPutChannel(`str${t}_cell_brand`,e.cellBrand),this.apiPutChannel(`str${t}_cell_model`,e.cellModel),this.apiPutChannel(`str${t}_Cnominal`,e.ratedCapacity),this.apiPutChannel(`str${t}_Vnominal`,e.nominalVoltage)];return v(s)}))}buildModbusPayload(t,e,r){let n=this.buildModbusSettings(r),i=[],l=1e4,a=(s,d=50)=>(s-1)%20*d;for(let s=1;s<=e;s++){let d=`str${t}_cell${s}`,o=`str${t}_sg_slave_${s}`,g=a(s),p={samplingInterval:8e3,loggingInterval:-1,samplingGroup:o,samplingTimeOffset:g,disabled:!1};i.push(_({id:`${d}_R`,description:`Cell (R) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:0:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1e3+(t-1)*l+s*2}:INTEGER`}]},p)),i.push(_({id:`${d}_V`,description:`Cell (V) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:1:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1300+(t-1)*l+s*2}:INTEGER`}]},p)),i.push(_({id:`${d}_T`,description:`Cell (T) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:2:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1600+(t-1)*l+s*2}:INTEGER`}]},p))}return i.push({id:`str${t}_total_I`,description:`String ${t} (I)`,channelAddress:"206:HOLDING_REGISTERS:0:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1900+(t-1)*l+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:8e3,loggingSettings:"sqllogger:",samplingGroup:`str${t}_sg_pack`,samplingTimeOffset:a(206),disabled:!1}),i.push({id:`str${t}_ambient_T`,description:`String ${t} (T ambient)`,channelAddress:"1:HOLDING_REGISTERS:2:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${2100+(t-1)*l+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:8e3,loggingSettings:"sqllogger:",samplingTimeOffset:a(106),disabled:!1}),{driver:"modbus",configs:{id:`str${t}_modbus`,description:`String ${t} Modbus RTU`,deviceAddress:r.port,settings:n,samplingTimeout:15e3,connectRetryInterval:15e3,disabled:!1},channels:i}}buildVirtualPayload(t,e){let r=[],n=(a,s,d,o,g)=>{let p={id:a,description:d,valueType:s,disabled:!1};o&&(p.unit=o),s.toUpperCase()==="STRING"&&(p.valueTypeLength=g||64),r.push(p)},i=(a,s,d,o)=>{let g={id:a,description:d,valueType:s,disabled:!1};(a.includes("_string_SOC")||a.includes("_string_SOH"))&&(g.loggingInterval=6e4,g.loggingSettings="sqllogger:"),o&&(g.unit=o),r.push(g)};n(`str${t}_cell_qty`,"INTEGER","number of cells"),n(`str${t}_Cnominal`,"DOUBLE","C nominal","Ah"),n(`str${t}_string_name`,"STRING","String name",void 0,64),n(`str${t}_cell_brand`,"STRING","Cell Brand",void 0,64),n(`str${t}_cell_model`,"STRING","Cell Model",void 0,64),n(`str${t}_Vnominal`,"DOUBLE","V nominal","V");let l=[[`str${t}_string_vol`,"DOUBLE","String Voltage","V"],[`str${t}_max_voltage_cell_id`,"INTEGER","Max V Cell ID",void 0],[`str${t}_min_voltage_cell_id`,"INTEGER","Min V Cell ID",void 0],[`str${t}_max_temp_cell_id`,"INTEGER","Max T Cell ID",void 0],[`str${t}_min_temp_cell_id`,"INTEGER","Min T Cell ID",void 0],[`str${t}_max_rst_cell_id`,"INTEGER","Max R Cell ID",void 0],[`str${t}_min_rst_cell_id`,"INTEGER","Min R Cell ID",void 0],[`str${t}_average_vol`,"DOUBLE","Average Cell Voltage","V"],[`str${t}_average_temp`,"DOUBLE","Average Cell Temperature","C"],[`str${t}_average_rst`,"DOUBLE","Average Cell R","miliOhm"],[`str${t}_max_voltage_value`,"DOUBLE","Max Cell Voltage","V"],[`str${t}_min_voltage_value`,"DOUBLE","Min Cell Voltage","V"],[`str${t}_max_temp_value`,"DOUBLE","Max Cell Temperature","C"],[`str${t}_min_temp_value`,"DOUBLE","Min Cell Temperature","C"],[`str${t}_max_rst_value`,"DOUBLE","Max Cell Internal Resistance","miliOhm"],[`str${t}_min_rst_value`,"DOUBLE","Min Cell Internal Resistance","miliOhm"],[`str${t}_string_SOC`,"DOUBLE","String SoC","%"],[`str${t}_string_SOH`,"DOUBLE","String SoH","%"]];for(let[a,s,d,o]of l)i(a,s,d,o);for(let a=1;a<=e;a++){let s=`str${t}_cell${a}`;i(`${s}_SOC`,"DOUBLE","State of Charge","%"),i(`${s}_SOH`,"DOUBLE","State of Health","%")}return{driver:"virtual",configs:{id:`str${t}_virtual`,description:`String ${t} calculated channels`,disabled:!1},channels:r}}buildModbusSettings(t){let e=t.stopBits.toString().replace(".","_");return`RTU:SERIAL_ENCODING_RTU:${t.baudRate}:DATABITS_${t.dataBits}:${t.parity}:STOPBITS_${e}:ECHO_FALSE:FLOWCONTROL_NONE:FLOWCONTROL_NONE`}apiPost(t,e){return this.http.post(`${this.BASE_URL}${t}`,e).pipe(h(this.handleError))}apiDelete(t){return this.http.delete(`${this.BASE_URL}${t}`).pipe(h(e=>e.status===404?c(null):this.handleError(e)))}apiPutChannel(t,e){let r=`/channels/${t}`,n={record:{flag:"VALID",value:e}};return this.http.put(`${this.BASE_URL}${r}`,n).pipe(h(this.handleError))}handleError(t){let e="Unknown error";return t.error instanceof ErrorEvent?e=`Client Error: ${t.error.message}`:(e=`Server Error (Code: ${t.status}): ${t.message}`,t.error&&typeof t.error=="string"?e+=` - ${t.error}`:t.error&&t.error.detail&&(e+=` - ${t.error.detail}`)),console.error(e),b(()=>new Error(e))}static \u0275fac=function(e){return new(e||u)(L(B),L(G))};static \u0275prov=U({token:u,factory:u.\u0275fac,providedIn:"root"})};export{V as a};
