import{t as v}from"./chunk-4PO2YNOU.js";import{B as m,Q as g,T as f,Z as _,ca as h,k as c,p as o,q as p,x as b}from"./chunk-OB35JHSB.js";var S=1e3,y=class i{constructor(e){this.http=e}devicesApiUrl="/rest/devices";channelsApiUrl="/rest/channels";deviceCache=new Map;getDeviceRecords(e){if(!this.deviceCache.has(e)){let t=b(0,S).pipe(f(()=>this.http.get(`${this.devicesApiUrl}/${e}`)),o(r=>{let l=new Map;if(r&&r.records)for(let n of r.records)n.record.flag==="VALID"&&l.set(n.id,n.record);return l}),g(1),m(r=>(console.error(`L\u1ED7i khi g\u1ECDi API cho device: ${e}`,r),c(new Map))));this.deviceCache.set(e,t)}return this.deviceCache.get(e)}getValue(e,t){return e.get(t)?.value??null}getTimestamp(e,t){return e.get(t)?.timestamp??null}getAsVolts(e,t){let r=this.getValue(e,t);return typeof r=="number"?t.includes("_cell")?r/1e3:r:null}getAsAmps(e,t){let r=this.getValue(e,t);return typeof r=="number"?r/100:null}getAsCelsius(e,t){let r=this.getValue(e,t);return typeof r=="number"?t.includes("_cell")?r/100:r:null}getAsRaw(e,t){let r=this.getValue(e,t);return typeof r=="number"?r:null}getAsString(e,t){let r=this.getValue(e,t);return typeof r=="string"?r:null}getSummaryData(e){return p({virtual:this.getDeviceRecords(`${e}_virtual`),modbus:this.getDeviceRecords(`${e}_modbus`)}).pipe(o(({virtual:t,modbus:r})=>{let l=this.getValue(t,`${e}_average_rst`),n=l!==null?l*1e5:null;return{stringName:this.getAsString(t,`${e}_string_name`),cellQty:this.getAsRaw(t,`${e}_cell_qty`),updateTime:this.getTimestamp(t,`${e}_string_vol`),rstUpdateTime:this.getTimestamp(t,`${e}_average_rst`),totalVoltage:this.getAsVolts(t,`${e}_string_vol`),stringCurrent:this.getAsAmps(r,`${e}_total_I`),avgVoltage:this.getAsVolts(t,`${e}_average_vol`),avgTemp:this.getAsCelsius(t,`${e}_average_temp`),avgRst:n,maxVolId:this.getAsRaw(t,`${e}_max_voltage_cell_id`),minVolId:this.getAsRaw(t,`${e}_min_voltage_cell_id`),maxRstId:this.getAsRaw(t,`${e}_max_rst_cell_id`),minRstId:this.getAsRaw(t,`${e}_min_rst_cell_id`),maxTempId:this.getAsRaw(t,`${e}_max_temp_cell_id`),minTempId:this.getAsRaw(t,`${e}_min_temp_cell_id`),maxVoltageValue:this.getAsVolts(t,`${e}_max_voltage_value`),minVoltageValue:this.getAsVolts(t,`${e}_min_voltage_value`),maxRstValue:this.getValue(t,`${e}_max_rst_value`),minRstValue:this.getValue(t,`${e}_min_rst_value`),maxTempValue:this.getAsCelsius(t,`${e}_max_temp_value`),minTempValue:this.getAsCelsius(t,`${e}_min_temp_value`),stringSoC:this.getAsRaw(t,`${e}_string_SOC`),stringSoH:this.getAsRaw(t,`${e}_string_SOH`)}}),g(1))}getCellsData(e,t){return p({virtual:this.getDeviceRecords(`${e}_virtual`),modbus:this.getDeviceRecords(`${e}_modbus`)}).pipe(o(({virtual:r,modbus:l})=>{let n=[],s=this.getAsRaw(l,`${e}_total_I`);for(let a=1;a<=t;a++){let u=this.getAsRaw(l,`${e}_cell${a}_R`),d=u!==null&&s!==null?u*s/1e5:null;n.push({ID:a,Vol:this.getAsVolts(l,`${e}_cell${a}_V`),Temp:this.getAsCelsius(l,`${e}_cell${a}_T`),Rst:u,SoC:this.getAsRaw(r,`${e}_cell${a}_SOC`),SoH:this.getAsRaw(r,`${e}_cell${a}_SOH`),IR:d})}return n}),g(1))}getDashboardStatus(){return this.http.get(this.devicesApiUrl).pipe(f(e=>{let r=e.devices.filter(l=>l.endsWith("_virtual")).map(l=>{let n=l.replace("_virtual","");return p({virtualMap:this.getDeviceRecords(l),modbusMap:this.getDeviceRecords(`${n}_modbus`)}).pipe(o(({virtualMap:s,modbusMap:a})=>{let u=this.getAsVolts(s,`${n}_average_vol`),d=this.getValue(s,`${n}_average_rst`),A=this.getAsVolts(s,`${n}_string_vol`),R=this.getAsAmps(a,`${n}_total_I`),$=this.getAsCelsius(s,`${n}_average_temp`),V=this.getAsRaw(s,`${n}_cell_qty`),C=this.getAsRaw(s,`${n}_string_SOC`),D=this.getAsRaw(s,`${n}_string_SOH`),I=u!==null&&u>0||V!==null&&V>0?"On":"Off",T=d!==null&&d>0?"On":"Off",w=A!==null&&A>0?"On":"Off",M=R!==null&&R!==0?"On":"Off",x=$!==null&&$!==0?"On":"Off";return{id:n,siteName:"Lego B\xECnh Thu\u1EADn (Default)",stringName:this.getAsString(s,`${n}_string_name`)||n,cellVol:I,cellRst:T,stringVol:w,current:M,ambient:x,soC:C,soH:D,updateTime:this.getTimestamp(s,`${n}_string_vol`)?new Date(this.getTimestamp(s,`${n}_string_vol`)):new Date}}))});return r.length===0?c([]):p(r)}),g(1))}getChannelHistory(e,t,r){return this.http.get(`${this.channelsApiUrl}/${e}/history`,{params:{from:t.toString(),until:r.toString()}}).pipe(o(l=>{if(console.log(`[OpenMUC] History response for ${e}:`,l),Array.isArray(l)){let n=l.map(s=>({timestamp:s.timestamp||s.time||0,value:typeof s.value=="number"?s.value:s.record?.value?parseFloat(s.record.value):0}));return console.log(`[OpenMUC] Parsed array data for ${e}:`,n),n}if(l.records&&Array.isArray(l.records)){let n=l.records.filter(s=>s.record?.flag==="VALID").map(s=>({timestamp:s.record.timestamp||0,value:typeof s.record.value=="number"?s.record.value:parseFloat(s.record.value||0)}));return console.log(`[OpenMUC] Parsed records data for ${e}:`,n),n}if(l.data&&Array.isArray(l.data)){let n=l.data.map(s=>({timestamp:s.timestamp||s.time||0,value:typeof s.value=="number"?s.value:parseFloat(s.value||0)}));return console.log(`[OpenMUC] Parsed data array for ${e}:`,n),n}return console.warn(`[OpenMUC] Unknown response format for ${e}:`,l),[]}),m(l=>(console.error(`Error loading history for channel ${e}:`,l),c([]))))}static \u0275fac=function(t){return new(t||i)(h(v))};static \u0275prov=_({token:i,factory:i.\u0275fac,providedIn:"root"})};var O=class i{constructor(e){this.http=e}BASE_URL="/rest";LATEST_VALUE_API="/rest/latest-value";SITE_NAME_CHANNEL="site_name_1";getSiteName(){return this.http.get(`${this.LATEST_VALUE_API}/site-name`).pipe(o(e=>(console.log("[Site] Latest-value API response:",e),e?.success&&typeof e.data=="string"&&e.data.trim().length>0?e.data:(console.warn("[Site] Unexpected latest-value response, falling back to default:",e),"My Monitoring Site"))),m(e=>(console.error("[Site] Could not load site name from latest-value, using default.",e),c("My Monitoring Site"))))}setSiteName(e){let t={record:{flag:"VALID",value:e}};return console.log("[Site] Saving site name:",e),this.http.put(`${this.BASE_URL}/channels/${this.SITE_NAME_CHANNEL}`,t).pipe(o(r=>(console.log("[Site] Site name saved successfully:",r),r)),m(r=>{throw console.error("[Site] Error saving site name:",r),r}))}static \u0275fac=function(t){return new(t||i)(h(v))};static \u0275prov=_({token:i,factory:i.\u0275fac,providedIn:"root"})};export{y as a,O as b};
