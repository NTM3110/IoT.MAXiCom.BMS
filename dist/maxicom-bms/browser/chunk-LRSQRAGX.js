import"./chunk-MS4AQ6UA.js";import{a as ht,b as vt,c as E,d as Mt}from"./chunk-PET2T5QB.js";import{a as Pt}from"./chunk-X5OCUUYT.js";import{a as wt,b as Dt,c as Et,e as Ft,f as Lt,g as Nt,h as Ot,i as Rt}from"./chunk-S6RU42MV.js";import{a as It}from"./chunk-DZUNLXFM.js";import{a as at,b as ot,c as lt,d as mt,e as st,f as dt,g as ct,h as pt,i as gt,j as ft,k as ut,l as _t,m as St}from"./chunk-M64ZZ4XY.js";import{a as xt,b as bt}from"./chunk-PBPL5AEM.js";import{i as Ct}from"./chunk-G6CURNGL.js";import{a as yt}from"./chunk-QAKHC542.js";import{a as Z,g as it,h as nt,i as rt}from"./chunk-ALYBDDWS.js";import{c as V}from"./chunk-MFMQ7P6F.js";import{Ia as q,La as Q,Na as p,Pa as z,Qa as G,Ta as H,Ua as U,Wa as Y,Xa as J,Ya as K,Za as W,_a as X,ab as tt,gb as et,h as k,i as I,ka as A,la as $,m as P,qa as j,sa as w,ta as D}from"./chunk-7DJ2AMDO.js";import{$b as T,Bb as d,J as v,Kb as r,Lb as n,Mb as c,Nb as C,Ob as h,Qb as N,Ub as u,Vb as _,Zb as O,_b as R,bb as m,dc as o,ec as S,fc as y,gb as g,ma as M,na as x,nb as b,nc as B,tb as f}from"./chunk-4XLDPXVN.js";import{a as L}from"./chunk-C6Q5SG76.js";function jt(e,t){e&1&&(r(0,"mat-option",16),o(1," No Serial Port found, please configure one! "),n()),e&2&&d("disabled",!0)}function qt(e,t){if(e&1&&(r(0,"mat-option",17),o(1),n()),e&2){let i=t.$implicit;d("value",i.id),m(),y(" ",i.alias," ")}}var F=class e{constructor(t,i,a){this.fb=t;this.dialogRef=i;this.data=a;this.isEditMode=!!a.string,this.serialPorts=a.serialPorts;let l=a.string;this.stringForm=this.fb.group({stringName:[l?.stringName||"",p.required],cellBrand:[l?.cellBrand||"Unknown",p.required],cellModel:[l?.cellModel||"Unknown",p.required],cellQty:[l?.cellQty||24,[p.required,p.min(1),p.max(250)]],ratedCapacity:[l?.ratedCapacity||100,[p.required,p.min(1)]],nominalVoltage:[l?.nominalVoltage||3.2,[p.required,p.min(1)]],serialPortId:[l?.serialPortId||null,p.required]})}stringForm;serialPorts=[];isEditMode;ngOnInit(){this.serialPorts.length===0&&this.stringForm.get("serialPortId")?.disable()}onSave(){this.stringForm.valid&&this.dialogRef.close(this.stringForm.value)}onCancel(){this.dialogRef.close()}static \u0275fac=function(i){return new(i||e)(g(W),g(wt),g(Dt))};static \u0275cmp=b({type:e,selectors:[["app-string-form"]],decls:39,vars:5,consts:[["mat-dialog-title",""],[1,"string-form",3,"formGroup"],["appearance","outline"],["matInput","","formControlName","stringName","required",""],["matInput","","formControlName","cellBrand"],["matInput","","formControlName","cellModel"],["matInput","","type","number","formControlName","cellQty","required",""],["matInput","","type","number","formControlName","ratedCapacity","required",""],["matInput","","type","number","formControlName","nominalVoltage","required",""],["appearance","outline",1,"form-field-full"],["formControlName","serialPortId","required",""],[3,"disabled",4,"ngIf"],[3,"value",4,"ngFor","ngForOf"],["align","end"],["mat-button","",3,"click"],["mat-flat-button","","color","primary",3,"click","disabled"],[3,"disabled"],[3,"value"]],template:function(i,a){i&1&&(r(0,"h2",0),o(1),n(),r(2,"mat-dialog-content")(3,"form",1)(4,"mat-form-field",2)(5,"mat-label"),o(6,"String Name"),n(),c(7,"input",3),n(),r(8,"mat-form-field",2)(9,"mat-label"),o(10,"Cell Brand"),n(),c(11,"input",4),n(),r(12,"mat-form-field",2)(13,"mat-label"),o(14,"Cell Model"),n(),c(15,"input",5),n(),r(16,"mat-form-field",2)(17,"mat-label"),o(18,"Cell Qty"),n(),c(19,"input",6),n(),r(20,"mat-form-field",2)(21,"mat-label"),o(22,"Rated Capacity (Ah)"),n(),c(23,"input",7),n(),r(24,"mat-form-field",2)(25,"mat-label"),o(26,"Rated Voltage (V)"),n(),c(27,"input",8),n(),r(28,"mat-form-field",9)(29,"mat-label"),o(30,"Serial Port"),n(),r(31,"mat-select",10),f(32,jt,2,1,"mat-option",11)(33,qt,2,2,"mat-option",12),n()()()(),r(34,"mat-dialog-actions",13)(35,"button",14),u("click",function(){return a.onCancel()}),o(36,"Cancel"),n(),r(37,"button",15),u("click",function(){return a.onSave()}),o(38," Save "),n()()),i&2&&(m(),S(a.isEditMode?"Edit String":"Add String"),m(2),d("formGroup",a.stringForm),m(29),d("ngIf",a.serialPorts.length===0),m(),d("ngForOf",a.serialPorts),m(4),d("disabled",a.stringForm.invalid))},dependencies:[P,k,I,X,H,Q,U,z,G,K,Y,J,Ot,Ft,Nt,Lt,it,et,tt,vt,ht,Ct,rt,nt,D,w],styles:[".string-form[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding-top:16px}.form-field-full[_ngcontent-%COMP%]{grid-column:1/-1}@media (max-width: 500px){.string-form[_ngcontent-%COMP%]{grid-template-columns:1fr}}"]})};var Qt=()=>[5,10,25];function zt(e,t){e&1&&(r(0,"div",10),c(1,"mat-spinner"),r(2,"p"),o(3,"Loading data..."),n()())}function Gt(e,t){e&1&&(r(0,"th",25),o(1,"Index"),n())}function Ht(e,t){if(e&1&&(r(0,"td",26),o(1),n()),e&2){let i=t.$implicit;m(),S(i.stringIndex)}}function Ut(e,t){e&1&&(r(0,"th",25),o(1,"Name"),n())}function Yt(e,t){if(e&1&&(r(0,"td",26),o(1),n()),e&2){let i=t.$implicit;m(),S(i.stringName)}}function Jt(e,t){e&1&&(r(0,"th",25),o(1,"Cell Qty"),n())}function Kt(e,t){if(e&1&&(r(0,"td",26),o(1),n()),e&2){let i=t.$implicit;m(),S(i.cellQty)}}function Wt(e,t){e&1&&(r(0,"th",25),o(1,"Serial Port"),n())}function Xt(e,t){if(e&1&&(r(0,"td",26),o(1),n()),e&2){let i=t.$implicit,a=_(2);m(),S(a.getPortAlias(i.serialPortId))}}function Zt(e,t){e&1&&(r(0,"th",25),o(1,"Actions"),n())}function te(e,t){if(e&1){let i=N();r(0,"td",26)(1,"button",27),u("click",function(){let l=M(i).$implicit,s=_(2);return x(s.viewStringDetail(l))}),r(2,"mat-icon"),o(3,"visibility"),n()(),r(4,"button",28),u("click",function(){let l=M(i).$implicit,s=_(2);return x(s.openStringForm(l))}),r(5,"mat-icon"),o(6,"edit"),n()(),r(7,"button",29),u("click",function(){let l=M(i).$implicit,s=_(2);return x(s.deleteString(l))}),r(8,"mat-icon"),o(9,"delete"),n()()()}}function ee(e,t){e&1&&c(0,"tr",30)}function ie(e,t){e&1&&c(0,"tr",31)}function ne(e,t){if(e&1&&(r(0,"tr",32)(1,"td",33),o(2," No Strings have been configured yet. "),n()()),e&2){let i=_(2);m(),d("colSpan",i.displayedColumns.length)}}function re(e,t){if(e&1&&(r(0,"mat-card",11)(1,"div",12)(2,"table",13),C(3,14),f(4,Gt,2,0,"th",15)(5,Ht,2,1,"td",16),h(),C(6,17),f(7,Ut,2,0,"th",15)(8,Yt,2,1,"td",16),h(),C(9,18),f(10,Jt,2,0,"th",15)(11,Kt,2,1,"td",16),h(),C(12,19),f(13,Wt,2,0,"th",15)(14,Xt,2,1,"td",16),h(),C(15,20),f(16,Zt,2,0,"th",15)(17,te,10,0,"td",16),h(),f(18,ee,1,0,"tr",21)(19,ie,1,0,"tr",22)(20,ne,3,1,"tr",23),n()(),c(21,"mat-paginator",24),n()),e&2){let i=_();m(2),d("dataSource",i.dataSource),m(16),d("matHeaderRowDef",i.displayedColumns),m(),d("matRowDefColumns",i.displayedColumns),m(2),d("pageSizeOptions",B(4,Qt))}}var Tt=class e{constructor(t,i,a,l,s,ae){this.router=t;this.dialog=i;this.snackBar=a;this.configService=l;this.batteryStringService=s;this.commService=ae}displayedColumns=["stringIndex","stringName","cellQty","serialPortId","actions"];dataSource=new St([]);isLoading=!0;siteName="";serialPorts=[];stringReloadInterval;paginator;ngOnInit(){this.siteName=this.configService.siteName,this.loadInitialData()}ngAfterViewInit(){this.dataSource.paginator=this.paginator}ngOnDestroy(){this.stringReloadInterval&&clearInterval(this.stringReloadInterval)}loadInitialData(){this.isLoading=!0,this.commService.getSerialPortsConfig().subscribe(t=>{this.serialPorts=t,this.loadStrings(),this.stringReloadInterval=setInterval(()=>{this.batteryStringService.reloadStrings().subscribe(i=>{let a=this.dataSource.data.map(s=>s.id).sort().join(","),l=i.map(s=>s.id).sort().join(",");a!==l&&(console.log("[StringList] Strings changed, updating..."),this.dataSource.data=i)})},5e3)})}loadStrings(){this.isLoading=!0,this.batteryStringService.getStrings().pipe(v(()=>this.isLoading=!1)).subscribe(t=>{this.dataSource.data=t},t=>{console.error("Error loading strings:",t)})}getPortAlias(t){let i=this.serialPorts.find(a=>a.id===t);return i?i.alias:t}openStringForm(t){this.dialog.open(F,{width:"600px",data:{string:t?L({},t):null,serialPorts:this.serialPorts}}).afterClosed().subscribe(a=>{if(!a)return;this.isLoading=!0;let l=this.serialPorts.find(s=>s.id===a.serialPortId);if(!l){this.showMessage("Error: Selected Serial Port not found.","error"),this.isLoading=!1;return}t?this.batteryStringService.updateString(t.id,a,l).pipe(v(()=>this.isLoading=!1)).subscribe({next:()=>{this.showMessage(`Updated ${a.stringName}`,"success"),this.loadStrings()},error:s=>this.showMessage(`Error updating: ${s.message}`,"error")}):this.batteryStringService.addString(a,l).pipe(v(()=>this.isLoading=!1)).subscribe({next:()=>{this.showMessage(`Added ${a.stringName}`,"success"),this.loadStrings()},error:s=>this.showMessage(`Error adding: ${s.message}`,"error")})})}deleteString(t){this.dialog.open(Rt,{width:"350px",data:{title:"Delete String",message:`Are you sure you want to delete "${t.stringName}"?
                  This action will delete all related API configuration.`,type:"danger"}}).afterClosed().subscribe(a=>{a&&(this.isLoading=!0,this.batteryStringService.deleteString(t.id).pipe(v(()=>this.isLoading=!1)).subscribe({next:()=>{this.showMessage(`Deleted ${t.stringName}`,"info"),this.loadStrings()},error:l=>this.showMessage(`Error deleting: ${l.message}`,"error")}))})}viewStringDetail(t){this.router.navigate(["/setting/string",t.id])}showMessage(t,i){this.snackBar.open(t,"Close",{duration:3e3,panelClass:[`${i}-snackbar`]})}static \u0275fac=function(i){return new(i||e)(g(V),g(Et),g(q),g(yt),g(It),g(Pt))};static \u0275cmp=b({type:e,selectors:[["app-string-list"]],viewQuery:function(i,a){if(i&1&&O(E,5),i&2){let l;R(l=T())&&(a.paginator=l.first)}},decls:16,vars:3,consts:[[1,"string-list-container"],[1,"page-header"],[1,"header-content"],[1,"page-title"],[1,"title-icon"],[1,"page-subtitle"],[1,"header-actions"],["mat-flat-button","","color","primary",3,"click"],["class","loading-spinner",4,"ngIf"],["class","table-card mat-elevation-z4",4,"ngIf"],[1,"loading-spinner"],[1,"table-card","mat-elevation-z4"],[1,"table-container"],["mat-table","","aria-label","String list",3,"dataSource"],["matColumnDef","stringIndex"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","stringName"],["matColumnDef","cellQty"],["matColumnDef","serialPortId"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["showFirstLastButtons","","aria-label","Select page of strings",3,"pageSizeOptions"],["mat-header-cell",""],["mat-cell",""],["mat-icon-button","","color","primary",3,"click"],["mat-icon-button","",3,"click"],["mat-icon-button","","color","warn",3,"click"],["mat-header-row",""],["mat-row",""],[1,"mat-row"],[1,"mat-cell",3,"colSpan"]],template:function(i,a){i&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3)(4,"mat-icon",4),o(5,"battery_charging_full"),n(),o(6," String Configuration "),n(),r(7,"p",5),o(8),n()(),r(9,"div",6)(10,"button",7),u("click",function(){return a.openStringForm()}),r(11,"mat-icon"),o(12,"add"),n(),o(13," Add String "),n()()(),f(14,zt,4,0,"div",8)(15,re,22,5,"mat-card",9),n()),i&2&&(m(8),y(" Manage Strings at site: ",a.siteName," "),m(6),d("ngIf",a.isLoading),m(),d("ngIf",!a.isLoading))},dependencies:[P,I,_t,at,lt,ct,mt,ot,pt,st,dt,gt,ft,ut,Mt,E,$,A,D,w,j,bt,xt,Z],styles:[".string-list-container[_ngcontent-%COMP%]{min-height:calc(100vh - var(--header-height) - 48px);animation:_ngcontent-%COMP%_fadeIn .5s ease-in}.page-header[_ngcontent-%COMP%]{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}.page-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]   .page-title[_ngcontent-%COMP%]{margin:0 0 8px;display:flex;align-items:center;gap:12px;color:var(--primary-color);font-size:1.8rem;font-weight:500}.page-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]   .page-title[_ngcontent-%COMP%]   .title-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--accent-color)}.page-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]   .page-subtitle[_ngcontent-%COMP%]{margin:0;color:#666;font-size:1rem;line-height:1.5}.loading-spinner[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:16px;color:#0009}.table-card[_ngcontent-%COMP%]{border-radius:16px;box-shadow:0 4px 20px #00000014;overflow:hidden}.table-container[_ngcontent-%COMP%]{overflow-x:auto}th.mat-header-cell[_ngcontent-%COMP%], td.mat-cell[_ngcontent-%COMP%]{padding:12px 16px}td.mat-cell[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-of-type{margin-right:4px}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}"]})};export{Tt as StringListComponent};
