import{c as w}from"./chunk-KZ4JRIZK.js";import{a as m}from"./chunk-5DZ3LLXB.js";import{r as d,t as v}from"./chunk-4PO2YNOU.js";import{B as n,T as g,Z as b,ca as u,g as h,k as o,p as c,v as f}from"./chunk-OB35JHSB.js";var I=class l{constructor(t,s,r){this.router=t;this.snackBar=s;this.http=r;let e=sessionStorage.getItem("session-active")==="true";this.isLoggedInSubject.next(e)}BASE_URL="/rest";LATEST_VALUE_API="/rest/latest-value";isLoggedInSubject=new h(!1);isLoggedIn$=this.isLoggedInSubject.asObservable();get isLoggedIn(){return this.isLoggedInSubject.value}login(t,s){let r=new d().set("accountID","1");return this.http.get(`${this.LATEST_VALUE_API}/account`,{params:r}).pipe(c(e=>{if(e?.success&&e.data){let a=e.data.username,i=e.data.password;return t===a&&s===i?(this.startSession(),!0):(this.showMessage("Incorrect username or password.","error"),!1)}return this.showMessage("Invalid response from authentication server.","error"),!1}),n(e=>(console.error("Error during login (latest-value API):",e),this.loginFallback(t,s))))}loginFallback(t,s){let r=this.http.get(`${this.BASE_URL}/channels/account_1_username`),e=this.http.get(`${this.BASE_URL}/channels/account_1_password`);return f([r,e]).pipe(c(([a,i])=>{let p=a.record.value,A=i.record.value;return t===p&&s===A?(this.startSession(),!0):(this.showMessage("Incorrect username or password.","error"),!1)}),n(a=>(console.error("Error during login (fallback):",a),this.showMessage("Could not connect to authentication server.","error"),o(!1))))}logout(){sessionStorage.removeItem("session-active"),this.isLoggedInSubject.next(!1),this.router.navigate(["/login"])}changePassword(t,s){let r=new d().set("accountID","1");return this.http.get(`${this.LATEST_VALUE_API}/account`,{params:r}).pipe(g(e=>{if(!e?.success||!e.data)return this.showMessage("Could not verify old password.","error"),o(!1);let a=e.data.password;if(t!==a)return this.showMessage("Incorrect old password.","error"),o(!1);let i={id:"account_1_password",valueType:"STRING",record:{timestamp:Date.now(),flag:"VALID",value:s}};return this.http.put(`${this.BASE_URL}/channels/account_1_password/latestRecord`,i,{responseType:"text"}).pipe(c(()=>(this.showMessage("Password changed successfully.","success"),!0)),n(p=>(this.showMessage("Error when changing password (latest-value API):",p.error),this.changePasswordFallback(t,s))))}),n(e=>(this.showMessage("Error when verifying old password (latest-value API):",e.error),this.changePasswordFallback(t,s))))}changePasswordFallback(t,s){return this.http.get(`${this.BASE_URL}/channels/account_1_password`).pipe(g(r=>{let e=r.record.value;return t!==e?(this.showMessage("Incorrect old password.","error"),o(!1)):this.apiPutChannel("account_1_password",s).pipe(c(()=>(this.showMessage("Password changed successfully.","success"),!0)),n(a=>(console.error("Error when changing password (fallback):",a),this.showMessage("Error saving new password.","error"),o(!1))))}))}startSession(){sessionStorage.setItem("session-active","true"),this.isLoggedInSubject.next(!0)}apiPutChannel(t,s){let r={record:{flag:"VALID",value:s}};return this.http.put(`${this.BASE_URL}/channels/${t}`,r)}showMessage(t,s){this.snackBar.open(t,"Close",{duration:3e3,panelClass:[`${s}-snackbar`]})}static \u0275fac=function(s){return new(s||l)(u(w),u(m),u(v))};static \u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"})};export{I as a};
