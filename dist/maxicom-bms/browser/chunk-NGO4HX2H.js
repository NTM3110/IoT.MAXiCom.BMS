import{c as w}from"./chunk-MFMQ7P6F.js";import{Ia as m,q as h,s as v}from"./chunk-7DJ2AMDO.js";import{B as i,T as g,Z as b,ca as l,g as d,k as n,p as u,v as f}from"./chunk-4XLDPXVN.js";var A=class p{constructor(t,s,r){this.router=t;this.snackBar=s;this.http=r;let e=sessionStorage.getItem("session-active")==="true";this.isLoggedInSubject.next(e)}BASE_URL="/api";LATEST_VALUE_API="/api/latest-value";isLoggedInSubject=new d(!1);isLoggedIn$=this.isLoggedInSubject.asObservable();get isLoggedIn(){return this.isLoggedInSubject.value}login(t,s){let r=new h().set("accountID","1");return this.http.get(`${this.LATEST_VALUE_API}/account`,{params:r}).pipe(u(e=>{if(e?.success&&e.data){let a=e.data.username,c=e.data.password;return t===a&&s===c?(this.startSession(),!0):(this.showMessage("Incorrect username or password.","error"),!1)}return this.showMessage("Invalid response from authentication server.","error"),!1}),i(e=>(console.error("Error during login (latest-value API):",e),this.loginFallback(t,s))))}loginFallback(t,s){let r=this.http.get(`${this.BASE_URL}/channels/account_1_username`),e=this.http.get(`${this.BASE_URL}/channels/account_1_password`);return f([r,e]).pipe(u(([a,c])=>{let o=a.record.value,I=c.record.value;return t===o&&s===I?(this.startSession(),!0):(this.showMessage("Incorrect username or password.","error"),!1)}),i(a=>(console.error("Error during login (fallback):",a),this.showMessage("Could not connect to authentication server.","error"),n(!1))))}logout(){sessionStorage.removeItem("session-active"),this.isLoggedInSubject.next(!1),this.router.navigate(["/login"])}changePassword(t,s){let r=new h().set("accountID","1");return this.http.get(`${this.LATEST_VALUE_API}/account`,{params:r}).pipe(g(e=>{if(!e?.success||!e.data)return this.showMessage("Could not verify old password.","error"),n(!1);let a=e.data.password;if(t!==a)return this.showMessage("Incorrect old password.","error"),n(!1);let c={accountID:1,password:s};return this.http.put(`${this.LATEST_VALUE_API}/account`,c).pipe(u(o=>o?.success?(this.showMessage("Password changed successfully.","success"),!0):(this.showMessage(o?.description||"Error saving new password.","error"),!1)),i(o=>(console.error("Error when changing password (latest-value API):",o),this.changePasswordFallback(t,s))))}),i(e=>(console.error("Error when verifying old password (latest-value API):",e),this.changePasswordFallback(t,s))))}changePasswordFallback(t,s){return this.http.get(`${this.BASE_URL}/channels/account_1_password`).pipe(g(r=>{let e=r.record.value;return t!==e?(this.showMessage("Incorrect old password.","error"),n(!1)):this.apiPutChannel("account_1_password",s).pipe(u(()=>(this.showMessage("Password changed successfully.","success"),!0)),i(a=>(console.error("Error when changing password (fallback):",a),this.showMessage("Error saving new password.","error"),n(!1))))}))}startSession(){sessionStorage.setItem("session-active","true"),this.isLoggedInSubject.next(!0)}apiPutChannel(t,s){let r={record:{flag:"VALID",value:s}};return this.http.put(`${this.BASE_URL}/channels/${t}`,r)}showMessage(t,s){this.snackBar.open(t,"Close",{duration:3e3,panelClass:[`${s}-snackbar`]})}static \u0275fac=function(s){return new(s||p)(l(w),l(m),l(v))};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};export{A as a};
