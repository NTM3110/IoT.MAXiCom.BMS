import{a as x}from"./chunk-QAKHC542.js";import{q as B,r as E,s as G}from"./chunk-7DJ2AMDO.js";import{B as h,F as L,T as f,W as I,Z as M,ca as O,g as A,k as c,l as $,p as m,v as _,x as T,z as R}from"./chunk-4XLDPXVN.js";import{a as b,b as U}from"./chunk-C6Q5SG76.js";var S=[];for(let u=0;u<256;++u)S.push((u+256).toString(16).slice(1));function V(u,t=0){return(S[u[t+0]]+S[u[t+1]]+S[u[t+2]]+S[u[t+3]]+"-"+S[u[t+4]]+S[u[t+5]]+"-"+S[u[t+6]]+S[u[t+7]]+"-"+S[u[t+8]]+S[u[t+9]]+"-"+S[u[t+10]]+S[u[t+11]]+S[u[t+12]]+S[u[t+13]]+S[u[t+14]]+S[u[t+15]]).toLowerCase()}var C,w=new Uint8Array(16);function D(){if(!C){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");C=crypto.getRandomValues.bind(crypto)}return C(w)}var H=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),N={randomUUID:H};function j(u,t,e){u=u||{};let r=u.random??u.rng?.()??D();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){if(e=e||0,e<0||e+16>t.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let i=0;i<16;++i)t[e+i]=r[i];return t}return V(r)}function q(u,t,e){return N.randomUUID&&!t&&!u?N.randomUUID():j(u,t,e)}var y=q;var F=class u{constructor(t,e){this.http=t;this.configService=e;this.serialPortDefinitions=this.configService.serialPorts,this.loadStringsFromStorage(),this.stringsLoadedSubject.next(!1),this.loadStringsFromApi()}BASE_URL="/api";latestValueApiUrl="/api/latest-value";STORAGE_KEY="maxicom-strings-config";MAX_STRING_SCAN=12;stringsState=[];isLoadingFromApi=!1;stringsLoadedSubject=new A(!1);serialPortDefinitions=[];loadStringsFromStorage(){try{let t=localStorage.getItem(this.STORAGE_KEY);t&&(this.stringsState=JSON.parse(t))}catch(t){console.error("Error reading String config from localStorage",t),this.stringsState=[]}}fetchStringDetailFromLatestValue(t){let e=new B().set("stringId",t.toString());return this.http.get(`${this.latestValueApiUrl}/string`,{params:e}).pipe(m(r=>r?.success?r.data:null),h(r=>(r instanceof E&&r.status!==400&&console.warn(`[Strings] Latest-value string API failed for stringId=${t}`,r),c(null))))}buildStringIndicesToCheck(t=!1){let e=this.stringsState.map(r=>r.stringIndex);if(t){let r=Array.from({length:this.MAX_STRING_SCAN},(s,a)=>a+1);return Array.from(new Set([...e,...r])).filter(s=>s>0).sort((s,a)=>s-a)}return e.filter(r=>r>0).sort((r,i)=>r-i)}hasStringDetail(t){return t?!!(t.stringName&&t.stringName.trim().length>0||t.cellBrand&&t.cellBrand.trim().length>0||t.cellModel&&t.cellModel.trim().length>0||typeof t.cellQty=="number"||typeof t.cnominal=="number"||typeof t.vnominal=="number"):!1}mapLatestValueDtoToBatteryString(t,e,r,i){let s=(a,l)=>{if(a==null)return l??0;let n=Number(a);return Number.isFinite(n)?n:l??0};return{id:i?.id||y(),stringIndex:r,stringName:t.stringName?.trim()||i?.stringName||e,cellQty:s(t.cellQty,i?.cellQty),cellBrand:t.cellBrand??i?.cellBrand??"",cellModel:t.cellModel??i?.cellModel??"",ratedCapacity:s(t.cnominal,i?.ratedCapacity),nominalVoltage:s(t.vnominal,i?.nominalVoltage),serialPortId:i?.serialPortId||""}}saveStringsToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.stringsState))}loadStringsFromApi(t=!1){if(this.isLoadingFromApi)return;this.isLoadingFromApi=!0,(t?this.getStringIndicesFromOpenMUC().pipe(m(r=>r.filter(i=>i>0).sort((i,s)=>i-s)),h(r=>(console.warn("[Strings] Failed to get devices from OpenMUC, using cache indices:",r),c(this.buildStringIndicesToCheck(t))))):c(this.buildStringIndicesToCheck(t))).pipe(f(r=>{if(r.length===0)return t&&(this.stringsState=[],this.saveStringsToStorage()),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),c([]);let i=new Map(this.stringsState.map(l=>[l.stringIndex,l])),s=t?new Set(r):null,a=r.map(l=>this.fetchStringDetailFromLatestValue(l).pipe(m(n=>({index:l,dto:n,source:"latest-value"})),h(n=>(n instanceof E&&n.status!==400&&console.warn(`[Strings] Failed to load latest-value for str${l}:`,n),c({index:l,dto:null,source:"latest-value"})))));return _(a).pipe(f(l=>{let n=l.filter(o=>!o.dto||!this.hasStringDetail(o.dto)).map(o=>o.index);if(n.length===0)return c(l);let d=n.map(o=>this.fetchStringDetailFromOpenMUC(o).pipe(m(g=>({index:o,dto:g,source:"openmuc"})),h(()=>c({index:o,dto:null,source:"openmuc"}))));return _(d).pipe(m(o=>{let g=new Map;return l.forEach(p=>g.set(p.index,p)),o.forEach(p=>{(!g.has(p.index)||!g.get(p.index)?.dto)&&g.set(p.index,p)}),Array.from(g.values())}))}),m(l=>{let n=new Map;l.forEach(({index:o,dto:g})=>{if(s&&!s.has(o))return;let p=i.get(o);if(g&&this.hasStringDetail(g)){let v=`str${o}`,P=this.mapLatestValueDtoToBatteryString(g,v,o,p);n.set(o,P)}else p&&!t&&n.set(o,p)}),t||i.forEach((o,g)=>{n.has(g)||n.set(g,o)});let d=Array.from(n.values()).sort((o,g)=>o.stringIndex-g.stringIndex);return this.stringsState=d,this.saveStringsToStorage(),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),d}))}),h(r=>(console.error("Error in loadStringsFromApi (latest-value mode):",r),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),c([])))).subscribe()}getStringIndicesFromOpenMUC(){return this.http.get(`${this.BASE_URL}/devices`).pipe(m(t=>{let e=[],r=/^str(\d+)_(modbus|virtual)$/;return t.devices?.forEach(i=>{let s=i.match(r);if(s){let a=parseInt(s[1],10);!isNaN(a)&&!e.includes(a)&&e.push(a)}}),e.sort((i,s)=>i-s)}),h(t=>(console.warn("[Strings] Failed to get devices from OpenMUC:",t),c([]))))}fetchStringDetailFromOpenMUC(t){let r=[`str${t}_string_name`,`str${t}_cell_qty`,`str${t}_cell_brand`,`str${t}_cell_model`,`str${t}_Cnominal`,`str${t}_Vnominal`].map(i=>this.http.get(`${this.BASE_URL}/channels/${i}`).pipe(m(s=>{let a=s?.record?.value;return{channel:i,value:a}}),h(()=>c({channel:i,value:null}))));return _(r).pipe(m(i=>{let s={};return i.forEach(({channel:a,value:l})=>{l!=null&&(a.includes("string_name")?s.stringName=String(l):a.includes("cell_qty")?s.cellQty=Number(l):a.includes("cell_brand")?s.cellBrand=String(l):a.includes("cell_model")?s.cellModel=String(l):a.includes("Cnominal")?s.cnominal=Number(l):a.includes("Vnominal")&&(s.vnominal=Number(l)))}),this.hasStringDetail(s)?s:null}),h(()=>c(null)))}getStrings(){return this.stringsLoadedSubject.pipe(R(t=>t),m(()=>[...this.stringsState]),L(1))}reloadStrings(){return this.stringsLoadedSubject.next(!1),this.isLoadingFromApi=!1,this.loadStringsFromApi(!0),this.stringsLoadedSubject.pipe(R(t=>t),m(()=>[...this.stringsState]),L(1))}getStringById(t){let e=this.stringsState.find(r=>r.id===t);return c(e)}deleteString(t){let e=this.stringsState.find(a=>a.id===t);if(!e)return $(()=>new Error("String Config not found"));let r=e.stringIndex,i=this.apiDelete(`/devices_v2/str${r}_modbus`),s=this.apiDelete(`/devices_v2/str${r}_virtual`);return _([i,s]).pipe(f(()=>{let a=`${this.latestValueApiUrl}/delete-string?stringId=${r}`;return this.http.post(a,null).pipe(m(()=>({success:!0})),h(l=>l instanceof E&&l.status===400?c({success:!0}):(console.warn(`[Strings] Failed to delete metadata for str${r}`,l),c({success:!1,error:l}))))}),I(()=>{this.stringsState=this.stringsState.filter(a=>a.id!==t),this.saveStringsToStorage(),this.stringsLoadedSubject.next(!0)}),f(()=>c(null)))}addString(t,e){return this.getStrings().pipe(f(r=>{this.stringsState=r;let s=this.stringsState.reduce((l,n)=>Math.max(l,n.stringIndex),0)+1,a=U(b({},t),{id:y(),stringIndex:s});return this.checkDeviceExists(s).pipe(f(l=>l?$(()=>new Error(`String ${s} already exists on OpenMUC. Please reload the page.`)):this.createStringApi(s,t,e).pipe(I(()=>{this.stringsState.push(a),this.saveStringsToStorage(),this.stringsLoadedSubject.next(!0)}),f(()=>T(2e3).pipe(f(()=>this.fetchStringDetailFromLatestValue(s).pipe(m(n=>n&&this.hasStringDetail(n)?this.mapLatestValueDtoToBatteryString(n,`str${s}`,s,a):a),h(()=>c(a)))))),I(n=>{let d=this.stringsState.findIndex(o=>o.id===a.id);d>=0&&(this.stringsState[d]=n,this.saveStringsToStorage())}),m(()=>a))))}))}checkDeviceExists(t){let e=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_modbus`).pipe(m(()=>!0),h(i=>i instanceof E&&i.status===404?c(!1):c(!1))),r=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_virtual`).pipe(m(()=>!0),h(i=>i instanceof E&&i.status===404?c(!1):c(!1)));return _([e,r]).pipe(m(([i,s])=>i||s))}updateString(t,e,r){let i=this.stringsState.find(n=>n.id===t);if(!i)return $(()=>new Error("String Config not found"));let s=i.stringIndex,a=this.apiDelete(`/devices_v2/str${s}_modbus`),l=this.apiDelete(`/devices_v2/str${s}_virtual`);return _([a,l]).pipe(f(()=>this.createStringApi(s,e,r)),I(()=>{let n=b(b({},i),e);this.stringsState=this.stringsState.map(d=>d.id===t?n:d),this.saveStringsToStorage()}))}createStringApi(t,e,r){let i=this.buildModbusPayload(t,e.cellQty,r),s=this.buildVirtualPayload(t,e.cellQty),a=this.apiPost(`/devices_v2/str${t}_modbus`,i),l=this.apiPost(`/devices_v2/str${t}_virtual`,s);return _([a,l]).pipe(f(()=>T(2e3)),f(()=>{let n=[this.apiPutChannel(`str${t}_string_name`,e.stringName),this.apiPutChannel(`str${t}_cell_qty`,e.cellQty),this.apiPutChannel(`str${t}_cell_brand`,e.cellBrand),this.apiPutChannel(`str${t}_cell_model`,e.cellModel),this.apiPutChannel(`str${t}_Cnominal`,e.ratedCapacity),this.apiPutChannel(`str${t}_Vnominal`,e.nominalVoltage)];return _(n)}))}buildModbusPayload(t,e,r){let i=this.buildModbusSettings(r),s=[],a=1e4,l=(n,d=50)=>(n-1)%20*d;for(let n=1;n<=e;n++){let d=`str${t}_cell${n}`,o=`str${t}_sg_slave_${n}`,g=l(n),p={samplingInterval:8e3,samplingGroup:o,samplingTimeOffset:g,disabled:!1};s.push(b({id:`${d}_R`,description:`Cell (R) (${d})`,channelAddress:`${n}:HOLDING_REGISTERS:0:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1e3+(t-1)*a+n*2}:INTEGER`}]},p)),s.push(b({id:`${d}_V`,description:`Cell (V) (${d})`,channelAddress:`${n}:HOLDING_REGISTERS:1:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1300+(t-1)*a+n*2}:INTEGER`}]},p)),s.push(b({id:`${d}_T`,description:`Cell (T) (${d})`,channelAddress:`${n}:HOLDING_REGISTERS:2:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1600+(t-1)*a+n*2}:INTEGER`}]},p))}return s.push({id:`str${t}_total_I`,description:`String ${t} (I)`,channelAddress:"206:HOLDING_REGISTERS:0:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1900+(t-1)*a+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:8e3,loggingSettings:"sqllogger:",samplingGroup:`str${t}_sg_pack`,samplingTimeOffset:l(206),disabled:!1}),s.push({id:`str${t}_ambient_T`,description:`String ${t} (T ambient)`,channelAddress:"1:HOLDING_REGISTERS:2:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${2100+(t-1)*a+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:8e3,loggingSettings:"sqllogger:",samplingTimeOffset:l(106),disabled:!1}),{driver:"modbus",configs:{id:`str${t}_modbus`,description:`String ${t} Modbus RTU`,deviceAddress:r.port,settings:i,samplingTimeout:15e3,connectRetryInterval:15e3,disabled:!1},channels:s}}buildVirtualPayload(t,e){let r=[],i=(n,d,o,g,p)=>{let v={id:n,description:o,valueType:d,disabled:!1};g&&(v.unit=g),d.toUpperCase()==="STRING"&&(v.valueTypeLength=p||64),r.push(v)},s=(n,d,o,g)=>{let p={id:n,description:o,valueType:d,disabled:!1};g&&(p.unit=g);let v=n.toUpperCase();v.includes("STRING_SOC")||v.includes("STRING_SOH")?(p.loggingInterval=6e4,p.loggingSettings="sqllogger:"):v.includes("_SOC")||v.includes("_SOH"),r.push(p)},a=(n,d,o,g)=>{let p={id:n,description:o,valueType:d,disabled:!1};g&&(p.unit=g),r.push(p)};i(`str${t}_cell_qty`,"INTEGER","number of cells"),i(`str${t}_Cnominal`,"DOUBLE","C nominal","Ah"),i(`str${t}_string_name`,"STRING","String name",void 0,64),i(`str${t}_cell_brand`,"STRING","Cell Brand",void 0,64),i(`str${t}_cell_model`,"STRING","Cell Model",void 0,64),i(`str${t}_Vnominal`,"DOUBLE","V nominal","V");let l=[[`str${t}_string_vol`,"DOUBLE","String Voltage","V"],[`str${t}_max_voltage_cell_id`,"INTEGER","Max V Cell ID",void 0],[`str${t}_min_voltage_cell_id`,"INTEGER","Min V Cell ID",void 0],[`str${t}_max_temp_cell_id`,"INTEGER","Max T Cell ID",void 0],[`str${t}_min_temp_cell_id`,"INTEGER","Min T Cell ID",void 0],[`str${t}_max_rst_cell_id`,"INTEGER","Max R Cell ID",void 0],[`str${t}_min_rst_cell_id`,"INTEGER","Min R Cell ID",void 0],[`str${t}_average_vol`,"DOUBLE","Average Cell Voltage","V"],[`str${t}_average_temp`,"DOUBLE","Average Cell Temperature","C"],[`str${t}_average_rst`,"DOUBLE","Average Cell R","miliOhm"],[`str${t}_max_voltage_value`,"DOUBLE","Max Cell Voltage","V"],[`str${t}_min_voltage_value`,"DOUBLE","Min Cell Voltage","V"],[`str${t}_max_temp_value`,"DOUBLE","Max Cell Temperature","C"],[`str${t}_min_temp_value`,"DOUBLE","Min Cell Temperature","C"],[`str${t}_max_rst_value`,"DOUBLE","Max Cell Internal Resistance","miliOhm"],[`str${t}_min_rst_value`,"DOUBLE","Min Cell Internal Resistance","miliOhm"],[`str${t}_string_SOC`,"DOUBLE","String SoC","%"],[`str${t}_string_SOH`,"DOUBLE","String SoH","%"]];for(let[n,d,o,g]of l)s(n,d,o,g);for(let n=1;n<=e;n++){let d=`str${t}_cell${n}`;a(`${d}_SOC`,"DOUBLE","State of Charge","%"),a(`${d}_SOH`,"DOUBLE","State of Health","%")}return{driver:"virtual",configs:{id:`str${t}_virtual`,description:`String ${t} calculated channels`,disabled:!1},channels:r}}buildModbusSettings(t){let e=t.stopBits.toString().replace(".","_");return`RTU:SERIAL_ENCODING_RTU:${t.baudRate}:DATABITS_${t.dataBits}:${t.parity}:STOPBITS_${e}:ECHO_FALSE:FLOWCONTROL_NONE:FLOWCONTROL_NONE`}apiPost(t,e){return this.http.post(`${this.BASE_URL}${t}`,e).pipe(h(this.handleError))}apiDelete(t){return this.http.delete(`${this.BASE_URL}${t}`).pipe(h(e=>e.status===404?c(null):this.handleError(e)))}apiPutChannel(t,e){let r=`/channels/${t}`,i={record:{flag:"VALID",value:e}};return this.http.put(`${this.BASE_URL}${r}`,i).pipe(h(this.handleError))}handleError(t){let e="Unknown error";return t.error instanceof ErrorEvent?e=`Client Error: ${t.error.message}`:(e=`Server Error (Code: ${t.status}): ${t.message}`,t.error&&typeof t.error=="string"?e+=` - ${t.error}`:t.error&&t.error.detail&&(e+=` - ${t.error.detail}`)),console.error(e),$(()=>new Error(e))}static \u0275fac=function(e){return new(e||u)(O(G),O(x))};static \u0275prov=M({token:u,factory:u.\u0275fac,providedIn:"root"})};export{F as a};
