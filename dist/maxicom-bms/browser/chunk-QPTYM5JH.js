import"./chunk-MS4AQ6UA.js";import{a as E,b as Mt}from"./chunk-O64OXNYJ.js";import{a as Pt}from"./chunk-ZCLD5EY5.js";import{a as ht,b as vt}from"./chunk-VZJTCMO4.js";import{a as Rt}from"./chunk-AEY5P3FD.js";import{a as wt,b as Dt,c as Et,e as Ft,f as Nt,g as Ot,h as Lt}from"./chunk-4DAIBQ2O.js";import{a as It}from"./chunk-CNETILLL.js";import{a as ot,b as at,c as lt,d as mt,e as st,f as dt,g as ct,h as pt,i as gt,j as ft,k as ut,l as _t,m as St}from"./chunk-WTXCY3NJ.js";import{a as xt,b as bt}from"./chunk-B4LNXPXW.js";import{a as yt}from"./chunk-L26O6Y2M.js";import{i as Ct}from"./chunk-5WMX25QH.js";import{a as it,b as nt,c as rt}from"./chunk-EYZQD4T5.js";import{a as Z}from"./chunk-KJHVRK6L.js";import{c as V}from"./chunk-KZ4JRIZK.js";import{a as j}from"./chunk-5DZ3LLXB.js";import{A as c,C as z,D as G,G as H,H as U,J as Y,K as J,L as K,M as W,N as X,P as tt,V as et,y as Q}from"./chunk-A7CVY6IQ.js";import{i as k,j as I,ma as A,n as P,na as q,ta as $,va as w,wa as D}from"./chunk-4PO2YNOU.js";import{$b as R,Cb as d,J as v,Lb as r,Mb as n,Nb as p,Ob as C,Pb as h,Rb as O,Vb as u,Wb as _,_b as L,ac as T,cb as m,ec as a,fc as S,gc as y,hb as g,ma as M,na as x,ob as b,oc as B,ub as f}from"./chunk-OB35JHSB.js";import{a as N}from"./chunk-C6Q5SG76.js";function $t(e,t){e&1&&(r(0,"mat-option",17),a(1," No Serial Port found, please configure one! "),n()),e&2&&d("disabled",!0)}function jt(e,t){if(e&1&&(r(0,"mat-option",18),a(1),n()),e&2){let i=t.$implicit;d("value",i.id),m(),y(" ",i.alias," ")}}var F=class e{constructor(t,i,o){this.fb=t;this.dialogRef=i;this.data=o;this.isEditMode=!!o.string,this.serialPorts=o.serialPorts;let l=o.string;this.stringForm=this.fb.group({stringName:[l?.stringName||"",c.required],cellBrand:[l?.cellBrand||"Unknown",c.required],cellModel:[l?.cellModel||"Unknown",c.required],cellQty:[l?.cellQty||24,[c.required,c.min(1),c.max(250)]],ratedCapacity:[l?.ratedCapacity||100,[c.required,c.min(1)]],cutoffVoltage:[l?.cutoffVoltage||1.85,[c.required,c.min(1)]],floatVoltage:[l?.floatVoltage||2.25,[c.required,c.min(1)]],serialPortId:[l?.serialPortId||null,c.required]})}stringForm;serialPorts=[];isEditMode;ngOnInit(){this.serialPorts.length===0&&this.stringForm.get("serialPortId")?.disable()}onSave(){this.stringForm.valid&&this.dialogRef.close(this.stringForm.value)}onCancel(){this.dialogRef.close()}static \u0275fac=function(i){return new(i||e)(g(W),g(wt),g(Dt))};static \u0275cmp=b({type:e,selectors:[["app-string-form"]],decls:43,vars:5,consts:[["mat-dialog-title",""],[1,"string-form",3,"formGroup"],["appearance","outline"],["matInput","","formControlName","stringName","required",""],["matInput","","formControlName","cellBrand"],["matInput","","formControlName","cellModel"],["matInput","","type","number","formControlName","cellQty","required",""],["matInput","","type","number","formControlName","ratedCapacity","required",""],["matInput","","type","number","formControlName","cutoffVoltage","required",""],["matInput","","type","number","formControlName","floatVoltage","required",""],["appearance","outline",1,"form-field-full"],["formControlName","serialPortId","required",""],[3,"disabled",4,"ngIf"],[3,"value",4,"ngFor","ngForOf"],["align","end"],["mat-button","",3,"click"],["mat-flat-button","","color","primary",3,"click","disabled"],[3,"disabled"],[3,"value"]],template:function(i,o){i&1&&(r(0,"h2",0),a(1),n(),r(2,"mat-dialog-content")(3,"form",1)(4,"mat-form-field",2)(5,"mat-label"),a(6,"String Name"),n(),p(7,"input",3),n(),r(8,"mat-form-field",2)(9,"mat-label"),a(10,"Cell Brand"),n(),p(11,"input",4),n(),r(12,"mat-form-field",2)(13,"mat-label"),a(14,"Cell Model"),n(),p(15,"input",5),n(),r(16,"mat-form-field",2)(17,"mat-label"),a(18,"Cell Qty"),n(),p(19,"input",6),n(),r(20,"mat-form-field",2)(21,"mat-label"),a(22,"Rated Capacity (Ah)"),n(),p(23,"input",7),n(),r(24,"mat-form-field",2)(25,"mat-label"),a(26,"Cutoff Voltage (V)"),n(),p(27,"input",8),n(),r(28,"mat-form-field",2)(29,"mat-label"),a(30,"Float Voltage (V)"),n(),p(31,"input",9),n(),r(32,"mat-form-field",10)(33,"mat-label"),a(34,"Serial Port"),n(),r(35,"mat-select",11),f(36,$t,2,1,"mat-option",12)(37,jt,2,2,"mat-option",13),n()()()(),r(38,"mat-dialog-actions",14)(39,"button",15),u("click",function(){return o.onCancel()}),a(40,"Cancel"),n(),r(41,"button",16),u("click",function(){return o.onSave()}),a(42," Save "),n()()),i&2&&(m(),S(o.isEditMode?"Edit String":"Add String"),m(2),d("formGroup",o.stringForm),m(33),d("ngIf",o.serialPorts.length===0),m(),d("ngForOf",o.serialPorts),m(4),d("disabled",o.stringForm.invalid))},dependencies:[P,k,I,X,H,Q,U,z,G,K,Y,J,Lt,Ft,Ot,Nt,it,et,tt,vt,ht,Ct,rt,nt,D,w],styles:[".string-form[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding-top:16px}.form-field-full[_ngcontent-%COMP%]{grid-column:1/-1}@media (max-width: 500px){.string-form[_ngcontent-%COMP%]{grid-template-columns:1fr}}"]})};var Qt=()=>[5,10,25];function zt(e,t){e&1&&(r(0,"div",10),p(1,"mat-spinner"),r(2,"p"),a(3,"Loading data..."),n()())}function Gt(e,t){e&1&&(r(0,"th",25),a(1,"Index"),n())}function Ht(e,t){if(e&1&&(r(0,"td",26),a(1),n()),e&2){let i=t.$implicit;m(),S(i.stringIndex)}}function Ut(e,t){e&1&&(r(0,"th",25),a(1,"Name"),n())}function Yt(e,t){if(e&1&&(r(0,"td",26),a(1),n()),e&2){let i=t.$implicit;m(),S(i.stringName)}}function Jt(e,t){e&1&&(r(0,"th",25),a(1,"Cell Qty"),n())}function Kt(e,t){if(e&1&&(r(0,"td",26),a(1),n()),e&2){let i=t.$implicit;m(),S(i.cellQty)}}function Wt(e,t){e&1&&(r(0,"th",25),a(1,"Serial Port"),n())}function Xt(e,t){if(e&1&&(r(0,"td",26),a(1),n()),e&2){let i=t.$implicit,o=_(2);m(),S(o.getPortAlias(i.serialPortId))}}function Zt(e,t){e&1&&(r(0,"th",25),a(1,"Actions"),n())}function te(e,t){if(e&1){let i=O();r(0,"td",26)(1,"button",27),u("click",function(){let l=M(i).$implicit,s=_(2);return x(s.viewStringDetail(l))}),r(2,"mat-icon"),a(3,"visibility"),n()(),r(4,"button",28),u("click",function(){let l=M(i).$implicit,s=_(2);return x(s.openStringForm(l))}),r(5,"mat-icon"),a(6,"edit"),n()(),r(7,"button",29),u("click",function(){let l=M(i).$implicit,s=_(2);return x(s.deleteString(l))}),r(8,"mat-icon"),a(9,"delete"),n()()()}}function ee(e,t){e&1&&p(0,"tr",30)}function ie(e,t){e&1&&p(0,"tr",31)}function ne(e,t){if(e&1&&(r(0,"tr",32)(1,"td",33),a(2," No Strings have been configured yet. "),n()()),e&2){let i=_(2);m(),d("colSpan",i.displayedColumns.length)}}function re(e,t){if(e&1&&(r(0,"mat-card",11)(1,"div",12)(2,"table",13),C(3,14),f(4,Gt,2,0,"th",15)(5,Ht,2,1,"td",16),h(),C(6,17),f(7,Ut,2,0,"th",15)(8,Yt,2,1,"td",16),h(),C(9,18),f(10,Jt,2,0,"th",15)(11,Kt,2,1,"td",16),h(),C(12,19),f(13,Wt,2,0,"th",15)(14,Xt,2,1,"td",16),h(),C(15,20),f(16,Zt,2,0,"th",15)(17,te,10,0,"td",16),h(),f(18,ee,1,0,"tr",21)(19,ie,1,0,"tr",22)(20,ne,3,1,"tr",23),n()(),p(21,"mat-paginator",24),n()),e&2){let i=_();m(2),d("dataSource",i.dataSource),m(16),d("matHeaderRowDef",i.displayedColumns),m(),d("matRowDefColumns",i.displayedColumns),m(2),d("pageSizeOptions",B(4,Qt))}}var Tt=class e{constructor(t,i,o,l,s,oe){this.router=t;this.dialog=i;this.snackBar=o;this.configService=l;this.batteryStringService=s;this.commService=oe}displayedColumns=["stringIndex","stringName","cellQty","serialPortId","actions"];dataSource=new St([]);isLoading=!0;siteName="";serialPorts=[];stringReloadInterval;paginator;ngOnInit(){this.siteName=this.configService.siteName,this.loadInitialData()}ngAfterViewInit(){this.dataSource.paginator=this.paginator}ngOnDestroy(){this.stringReloadInterval&&clearInterval(this.stringReloadInterval)}loadInitialData(){this.isLoading=!0,this.commService.getSerialPortsConfig().subscribe(t=>{this.serialPorts=t,console.log("POrt 0:",t[0].port),this.loadStrings(),this.stringReloadInterval=setInterval(()=>{this.batteryStringService.reloadStrings().subscribe(i=>{let o=this.dataSource.data.map(s=>s.id).sort().join(","),l=i.map(s=>s.id).sort().join(",");o!==l&&(console.log("[StringList] Strings changed, updating..."),this.dataSource.data=i)})},5e3)})}loadStrings(){this.isLoading=!0,this.batteryStringService.getStrings().pipe(v(()=>this.isLoading=!1)).subscribe(t=>{console.log("Serial port of String 1:",t[0].serialPortId),this.dataSource.data=t},t=>{console.error("Error loading strings:",t)})}getPortAlias(t){let i=this.serialPorts.find(o=>o.id===t);return i?i.alias:t}openStringForm(t){this.dialog.open(F,{width:"600px",data:{string:t?N({},t):null,serialPorts:this.serialPorts}}).afterClosed().subscribe(o=>{if(!o)return;this.isLoading=!0;let l=this.serialPorts.find(s=>s.id===o.serialPortId);if(!l){this.showMessage("Error: Selected Serial Port not found.","error"),this.isLoading=!1;return}t?this.batteryStringService.updateString(t.id,o,l).pipe(v(()=>this.isLoading=!1)).subscribe({next:()=>{this.showMessage(`Updated ${o.stringName}`,"success"),this.loadStrings()},error:s=>this.showMessage(`Error updating: ${s.message}`,"error")}):this.batteryStringService.addString(o,l).pipe(v(()=>this.isLoading=!1)).subscribe({next:()=>{this.showMessage(`Added ${o.stringName}`,"success"),this.loadStrings()},error:s=>this.showMessage(`Error adding: ${s.message}`,"error")})})}deleteString(t){this.dialog.open(Rt,{width:"350px",data:{title:"Delete String",message:`Are you sure you want to delete "${t.stringName}"?
                  This action will delete all related API configuration.`,type:"danger"}}).afterClosed().subscribe(o=>{o&&(this.isLoading=!0,this.batteryStringService.deleteString(t.id).pipe(v(()=>this.isLoading=!1)).subscribe({next:()=>{this.showMessage(`Deleted ${t.stringName}`,"info"),this.loadStrings()},error:l=>this.showMessage(`Error deleting: ${l.message}`,"error")}))})}viewStringDetail(t){this.router.navigate(["/setting/string",t.id])}showMessage(t,i){this.snackBar.open(t,"Close",{duration:3e3,panelClass:[`${i}-snackbar`]})}static \u0275fac=function(i){return new(i||e)(g(V),g(Et),g(j),g(yt),g(It),g(Pt))};static \u0275cmp=b({type:e,selectors:[["app-string-list"]],viewQuery:function(i,o){if(i&1&&L(E,5),i&2){let l;R(l=T())&&(o.paginator=l.first)}},decls:16,vars:3,consts:[[1,"string-list-container"],[1,"page-header"],[1,"header-content"],[1,"page-title"],[1,"title-icon"],[1,"page-subtitle"],[1,"header-actions"],["mat-flat-button","","color","primary",3,"click"],["class","loading-spinner",4,"ngIf"],["class","table-card mat-elevation-z4",4,"ngIf"],[1,"loading-spinner"],[1,"table-card","mat-elevation-z4"],[1,"table-container"],["mat-table","","aria-label","String list",3,"dataSource"],["matColumnDef","stringIndex"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","stringName"],["matColumnDef","cellQty"],["matColumnDef","serialPortId"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["showFirstLastButtons","","aria-label","Select page of strings",3,"pageSizeOptions"],["mat-header-cell",""],["mat-cell",""],["mat-icon-button","","color","primary",3,"click"],["mat-icon-button","",3,"click"],["mat-icon-button","","color","warn",3,"click"],["mat-header-row",""],["mat-row",""],[1,"mat-row"],[1,"mat-cell",3,"colSpan"]],template:function(i,o){i&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3)(4,"mat-icon",4),a(5,"battery_charging_full"),n(),a(6," String Configuration "),n(),r(7,"p",5),a(8),n()(),r(9,"div",6)(10,"button",7),u("click",function(){return o.openStringForm()}),r(11,"mat-icon"),a(12,"add"),n(),a(13," Add String "),n()()(),f(14,zt,4,0,"div",8)(15,re,22,5,"mat-card",9),n()),i&2&&(m(8),y(" Manage Strings at site: ",o.siteName," "),m(6),d("ngIf",o.isLoading),m(),d("ngIf",!o.isLoading))},dependencies:[P,I,_t,ot,lt,ct,mt,at,pt,st,dt,gt,ft,ut,Mt,E,q,A,D,w,$,bt,xt,Z],styles:[".string-list-container[_ngcontent-%COMP%]{min-height:calc(100vh - var(--header-height) - 48px);animation:_ngcontent-%COMP%_fadeIn .5s ease-in}.page-header[_ngcontent-%COMP%]{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}.page-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]   .page-title[_ngcontent-%COMP%]{margin:0 0 8px;display:flex;align-items:center;gap:12px;color:var(--primary-color);font-size:1.8rem;font-weight:500}.page-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]   .page-title[_ngcontent-%COMP%]   .title-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--accent-color)}.page-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]   .page-subtitle[_ngcontent-%COMP%]{margin:0;color:#666;font-size:1rem;line-height:1.5}.loading-spinner[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:16px;color:#0009}.table-card[_ngcontent-%COMP%]{border-radius:16px;box-shadow:0 4px 20px #00000014;overflow:hidden}.table-container[_ngcontent-%COMP%]{overflow-x:auto}th.mat-header-cell[_ngcontent-%COMP%], td.mat-cell[_ngcontent-%COMP%]{padding:12px 16px}td.mat-cell[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-of-type{margin-right:4px}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}"]})};export{Tt as StringListComponent};
