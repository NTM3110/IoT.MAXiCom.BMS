import{a as G}from"./chunk-QAKHC542.js";import{q as U,r as _,s as M}from"./chunk-7DJ2AMDO.js";import{B as S,F as R,T as f,W as E,Z as B,ca as D,g as A,k as p,l as b,p as c,v,x as I,z as T}from"./chunk-4XLDPXVN.js";import{a as $,b as N}from"./chunk-C6Q5SG76.js";var m=[];for(let u=0;u<256;++u)m.push((u+256).toString(16).slice(1));function x(u,t=0){return(m[u[t+0]]+m[u[t+1]]+m[u[t+2]]+m[u[t+3]]+"-"+m[u[t+4]]+m[u[t+5]]+"-"+m[u[t+6]]+m[u[t+7]]+"-"+m[u[t+8]]+m[u[t+9]]+"-"+m[u[t+10]]+m[u[t+11]]+m[u[t+12]]+m[u[t+13]]+m[u[t+14]]+m[u[t+15]]).toLowerCase()}var L,w=new Uint8Array(16);function O(){if(!L){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");L=crypto.getRandomValues.bind(crypto)}return L(w)}var H=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),C={randomUUID:H};function j(u,t,e){u=u||{};let r=u.random??u.rng?.()??O();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){if(e=e||0,e<0||e+16>t.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let i=0;i<16;++i)t[e+i]=r[i];return t}return x(r)}function q(u,t,e){return C.randomUUID&&!t&&!u?C.randomUUID():j(u,t,e)}var y=q;var V=class u{constructor(t,e){this.http=t;this.configService=e;this.serialPortDefinitions=this.configService.serialPorts,this.loadStringsFromStorage(),this.stringsLoadedSubject.next(!1),this.loadStringsFromApi()}BASE_URL="/api";latestValueApiUrl="/api/latest-value";STORAGE_KEY="maxicom-strings-config";MAX_STRING_SCAN=12;stringsState=[];isLoadingFromApi=!1;stringsLoadedSubject=new A(!1);serialPortDefinitions=[];loadStringsFromStorage(){try{let t=localStorage.getItem(this.STORAGE_KEY);t&&(this.stringsState=JSON.parse(t))}catch(t){console.error("Error reading String config from localStorage",t),this.stringsState=[]}}fetchStringDetailFromLatestValue(t){let e=new U().set("stringId",t.toString());return this.http.get(`${this.latestValueApiUrl}/string`,{params:e}).pipe(c(r=>r?.success?r.data:null),S(r=>(r instanceof _&&r.status!==400&&console.warn(`[Strings] Latest-value string API failed for stringId=${t}`,r),p(null))))}buildStringIndicesToCheck(t=!1){let e=this.stringsState.map(r=>r.stringIndex);if(t){let r=Array.from({length:this.MAX_STRING_SCAN},(n,l)=>l+1);return Array.from(new Set([...e,...r])).filter(n=>n>0).sort((n,l)=>n-l)}return e.filter(r=>r>0).sort((r,i)=>r-i)}hasStringDetail(t){return t?!!(t.stringName&&t.stringName.trim().length>0||t.cellBrand&&t.cellBrand.trim().length>0||t.cellModel&&t.cellModel.trim().length>0||typeof t.cellQty=="number"||typeof t.cnominal=="number"||typeof t.vnominal=="number"):!1}mapLatestValueDtoToBatteryString(t,e,r,i){let n=(l,a)=>{if(l==null)return a??0;let s=Number(l);return Number.isFinite(s)?s:a??0};return{id:i?.id||y(),stringIndex:r,stringName:t.stringName?.trim()||i?.stringName||e,cellQty:n(t.cellQty,i?.cellQty),cellBrand:t.cellBrand??i?.cellBrand??"",cellModel:t.cellModel??i?.cellModel??"",ratedCapacity:n(t.cnominal,i?.ratedCapacity),nominalVoltage:n(t.vnominal,i?.nominalVoltage),serialPortId:i?.serialPortId||""}}saveStringsToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.stringsState))}loadStringsFromApi(t=!1){if(this.isLoadingFromApi)return;this.isLoadingFromApi=!0,(t?this.getStringIndicesFromOpenMUC().pipe(c(r=>r.filter(i=>i>0).sort((i,n)=>i-n)),S(r=>(console.warn("[Strings] Failed to get devices from OpenMUC, using cache indices:",r),p(this.buildStringIndicesToCheck(t))))):p(this.buildStringIndicesToCheck(t))).pipe(f(r=>{if(r.length===0)return t&&(this.stringsState=[],this.saveStringsToStorage()),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),p([]);let i=new Map(this.stringsState.map(a=>[a.stringIndex,a])),n=t?new Set(r):null,l=r.map(a=>this.fetchStringDetailFromLatestValue(a).pipe(c(s=>({index:a,dto:s,source:"latest-value"})),S(s=>(s instanceof _&&s.status!==400&&console.warn(`[Strings] Failed to load latest-value for str${a}:`,s),p({index:a,dto:null,source:"latest-value"})))));return v(l).pipe(f(a=>{let s=a.filter(o=>!o.dto||!this.hasStringDetail(o.dto)).map(o=>o.index);if(s.length===0)return p(a);let d=s.map(o=>this.fetchStringDetailFromOpenMUC(o).pipe(c(g=>({index:o,dto:g,source:"openmuc"})),S(()=>p({index:o,dto:null,source:"openmuc"}))));return v(d).pipe(c(o=>{let g=new Map;return a.forEach(h=>g.set(h.index,h)),o.forEach(h=>{(!g.has(h.index)||!g.get(h.index)?.dto)&&g.set(h.index,h)}),Array.from(g.values())}))}),c(a=>{let s=new Map;a.forEach(({index:o,dto:g})=>{if(n&&!n.has(o))return;let h=i.get(o);if(g&&this.hasStringDetail(g)){let F=`str${o}`,P=this.mapLatestValueDtoToBatteryString(g,F,o,h);s.set(o,P)}else h&&!t&&s.set(o,h)}),t||i.forEach((o,g)=>{s.has(g)||s.set(g,o)});let d=Array.from(s.values()).sort((o,g)=>o.stringIndex-g.stringIndex);return this.stringsState=d,this.saveStringsToStorage(),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),d}))}),S(r=>(console.error("Error in loadStringsFromApi (latest-value mode):",r),this.isLoadingFromApi=!1,this.stringsLoadedSubject.next(!0),p([])))).subscribe()}getStringIndicesFromOpenMUC(){return this.http.get(`${this.BASE_URL}/devices`).pipe(c(t=>{let e=[],r=/^str(\d+)_(modbus|virtual)$/;return t.devices?.forEach(i=>{let n=i.match(r);if(n){let l=parseInt(n[1],10);!isNaN(l)&&!e.includes(l)&&e.push(l)}}),e.sort((i,n)=>i-n)}),S(t=>(console.warn("[Strings] Failed to get devices from OpenMUC:",t),p([]))))}fetchStringDetailFromOpenMUC(t){let r=[`str${t}_string_name`,`str${t}_cell_qty`,`str${t}_cell_brand`,`str${t}_cell_model`,`str${t}_Cnominal`,`str${t}_Vnominal`].map(i=>this.http.get(`${this.BASE_URL}/channels/${i}`).pipe(c(n=>{let l=n?.record?.value;return{channel:i,value:l}}),S(()=>p({channel:i,value:null}))));return v(r).pipe(c(i=>{let n={};return i.forEach(({channel:l,value:a})=>{a!=null&&(l.includes("string_name")?n.stringName=String(a):l.includes("cell_qty")?n.cellQty=Number(a):l.includes("cell_brand")?n.cellBrand=String(a):l.includes("cell_model")?n.cellModel=String(a):l.includes("Cnominal")?n.cnominal=Number(a):l.includes("Vnominal")&&(n.vnominal=Number(a)))}),this.hasStringDetail(n)?n:null}),S(()=>p(null)))}getStrings(){return this.stringsLoadedSubject.pipe(T(t=>t),c(()=>[...this.stringsState]),R(1))}reloadStrings(){return this.stringsLoadedSubject.next(!1),this.isLoadingFromApi=!1,this.loadStringsFromApi(!0),this.stringsLoadedSubject.pipe(T(t=>t),c(()=>[...this.stringsState]),R(1))}getStringById(t){let e=this.stringsState.find(r=>r.id===t);return p(e)}deleteString(t){let e=this.stringsState.find(l=>l.id===t);if(!e)return b(()=>new Error("String Config not found"));let r=e.stringIndex,i=this.apiDelete(`/devices_v2/str${r}_modbus`),n=this.apiDelete(`/devices_v2/str${r}_virtual`);return v([i,n]).pipe(f(()=>{let l=`${this.latestValueApiUrl}/delete-string?stringId=${r}`;return this.http.post(l,null).pipe(c(()=>({success:!0})),S(a=>a instanceof _&&a.status===400?(console.log(`[Strings] String str${r} not found in latest-value DB (already deleted or never created), considering delete successful`),p({success:!0})):(console.warn(`[Strings] Failed to delete string metadata for str${r} from latest-value DB:`,a),p({success:!1,error:a}))))}),E(()=>{this.stringsState=this.stringsState.filter(l=>l.id!==t),this.saveStringsToStorage()}),f(()=>(this.loadStringsFromApi(),I(500).pipe(c(()=>null)))))}addString(t,e){return this.getStrings().pipe(f(r=>{this.stringsState=r;let n=this.stringsState.reduce((a,s)=>Math.max(a,s.stringIndex),0)+1,l=N($({},t),{id:y(),stringIndex:n});return this.checkDeviceExists(n).pipe(f(a=>a?b(()=>new Error(`String ${n} already exists on OpenMUC. Please reload the page.`)):this.createStringApi(n,t,e).pipe(E(()=>{this.stringsState.push(l),this.saveStringsToStorage(),this.stringsLoadedSubject.next(!0)}),f(()=>I(2e3).pipe(f(()=>this.fetchStringDetailFromLatestValue(n).pipe(c(s=>s&&this.hasStringDetail(s)?this.mapLatestValueDtoToBatteryString(s,`str${n}`,n,l):l),S(()=>p(l)))))),E(s=>{let d=this.stringsState.findIndex(o=>o.id===l.id);d>=0&&(this.stringsState[d]=s,this.saveStringsToStorage())}),c(()=>l))))}))}checkDeviceExists(t){let e=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_modbus`).pipe(c(()=>!0),S(i=>i instanceof _&&i.status===404?p(!1):p(!1))),r=this.http.get(`${this.BASE_URL}/devices_v2/str${t}_virtual`).pipe(c(()=>!0),S(i=>i instanceof _&&i.status===404?p(!1):p(!1)));return v([e,r]).pipe(c(([i,n])=>i||n))}updateString(t,e,r){let i=this.stringsState.find(s=>s.id===t);if(!i)return b(()=>new Error("String Config not found"));let n=i.stringIndex,l=this.apiDelete(`/devices_v2/str${n}_modbus`),a=this.apiDelete(`/devices_v2/str${n}_virtual`);return v([l,a]).pipe(f(()=>this.createStringApi(n,e,r)),E(()=>{let s=$($({},i),e);this.stringsState=this.stringsState.map(d=>d.id===t?s:d),this.saveStringsToStorage()}))}createStringApi(t,e,r){let i=this.buildModbusPayload(t,e.cellQty,r),n=this.buildVirtualPayload(t,e.cellQty),l=this.apiPost(`/devices_v2/str${t}_modbus`,i),a=this.apiPost(`/devices_v2/str${t}_virtual`,n);return v([l,a]).pipe(f(()=>I(2e3)),f(()=>{let s=[this.apiPutChannel(`str${t}_string_name`,e.stringName),this.apiPutChannel(`str${t}_cell_qty`,e.cellQty),this.apiPutChannel(`str${t}_cell_brand`,e.cellBrand),this.apiPutChannel(`str${t}_cell_model`,e.cellModel),this.apiPutChannel(`str${t}_Cnominal`,e.ratedCapacity),this.apiPutChannel(`str${t}_Vnominal`,e.nominalVoltage)];return v(s)}))}buildModbusPayload(t,e,r){let i=this.buildModbusSettings(r),n=[],l=1e4,a=(s,d=50)=>(s-1)%20*d;for(let s=1;s<=e;s++){let d=`str${t}_cell${s}`,o=`str${t}_sg_slave_${s}`,g=a(s);n.push({id:`${d}_R`,description:`Cell (R) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:0:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1e3+(t-1)*l+s*2}:INTEGER`}],samplingInterval:8e3,samplingGroup:o,samplingTimeOffset:g,disabled:!1}),n.push({id:`${d}_V`,description:`Cell (V) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:1:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1300+(t-1)*l+s*2}:INTEGER`}],samplingInterval:8e3,samplingGroup:o,samplingTimeOffset:g,disabled:!1}),n.push({id:`${d}_T`,description:`Cell (T) (${d})`,channelAddress:`${s}:HOLDING_REGISTERS:2:INT16`,valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1600+(t-1)*l+s*2}:INTEGER`}],samplingInterval:8e3,samplingGroup:o,samplingTimeOffset:g,disabled:!1})}return n.push({id:`str${t}_total_I`,description:`String ${t} (I)`,channelAddress:"206:HOLDING_REGISTERS:0:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${1900+(t-1)*l+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:1e3,loggingSettings:"sqllogger:",samplingGroup:`str${t}_sg_pack`,samplingTimeOffset:a(206),disabled:!1}),n.push({id:`str${t}_ambient_T`,description:`String ${t} (T ambient)`,channelAddress:"1:HOLDING_REGISTERS:2:INT16",valueType:"INTEGER",serverMappings:[{id:"modbus",serverAddress:`HOLDING_REGISTERS:${2100+(t-1)*l+t}:INTEGER`}],samplingInterval:8e3,loggingInterval:1e3,loggingSettings:"sqllogger:",samplingTimeOffset:a(106),disabled:!1}),{driver:"modbus",configs:{id:`str${t}_modbus`,description:`String ${t} Modbus RTU`,deviceAddress:r.port,settings:i,samplingTimeout:15e3,connectRetryInterval:15e3,disabled:!1},channels:n}}buildVirtualPayload(t,e){let r=[],i=(a,s,d,o,g)=>{let h={id:a,description:d,valueType:s,disabled:!1};o&&(h.unit=o),s.toUpperCase()==="STRING"&&(h.valueTypeLength=g||64),r.push(h)},n=(a,s,d,o)=>{let g={id:a,description:d,valueType:s,loggingInterval:6e4,loggingSettings:"sqllogger:",disabled:!1};o&&(g.unit=o),r.push(g)};i(`str${t}_cell_qty`,"INTEGER","number of cells"),i(`str${t}_Cnominal`,"DOUBLE","C nominal","Ah"),i(`str${t}_string_name`,"STRING","String name",void 0,64),i(`str${t}_cell_brand`,"STRING","Cell Brand",void 0,64),i(`str${t}_cell_model`,"STRING","Cell Model",void 0,64),i(`str${t}_Vnominal`,"DOUBLE","V nominal","V");let l=[[`str${t}_string_vol`,"DOUBLE","String Voltage","V"],[`str${t}_max_voltage_cell_id`,"INTEGER","Max V Cell ID",void 0],[`str${t}_min_voltage_cell_id`,"INTEGER","Min V Cell ID",void 0],[`str${t}_max_temp_cell_id`,"INTEGER","Max T Cell ID",void 0],[`str${t}_min_temp_cell_id`,"INTEGER","Min T Cell ID",void 0],[`str${t}_max_rst_cell_id`,"INTEGER","Max R Cell ID",void 0],[`str${t}_min_rst_cell_id`,"INTEGER","Min R Cell ID",void 0],[`str${t}_average_vol`,"DOUBLE","Average Cell Voltage","V"],[`str${t}_average_temp`,"DOUBLE","Average Cell Temperature","C"],[`str${t}_average_rst`,"DOUBLE","Average Cell R","miliOhm"],[`str${t}_max_voltage_value`,"DOUBLE","Max Cell Voltage","V"],[`str${t}_min_voltage_value`,"DOUBLE","Min Cell Voltage","V"],[`str${t}_max_temp_value`,"DOUBLE","Max Cell Temperature","C"],[`str${t}_min_temp_value`,"DOUBLE","Min Cell Temperature","C"],[`str${t}_max_rst_value`,"DOUBLE","Max Cell Internal Resistance","miliOhm"],[`str${t}_min_rst_value`,"DOUBLE","Min Cell Internal Resistance","miliOhm"],[`str${t}_string_SOC`,"DOUBLE","String SoC","%"],[`str${t}_string_SOH`,"DOUBLE","String SoH","%"]];for(let[a,s,d,o]of l)n(a,s,d,o);for(let a=1;a<=e;a++){let s=`str${t}_cell${a}`;n(`${s}_SOC`,"DOUBLE","State of Charge","%"),n(`${s}_SOH`,"DOUBLE","State of Health","%")}return{driver:"virtual",configs:{id:`str${t}_virtual`,description:`String ${t} calculated channels`,disabled:!1},channels:r}}buildModbusSettings(t){let e=t.stopBits.toString().replace(".","_");return`RTU:SERIAL_ENCODING_RTU:${t.baudRate}:DATABITS_${t.dataBits}:${t.parity}:STOPBITS_${e}:ECHO_FALSE:FLOWCONTROL_NONE:FLOWCONTROL_NONE`}apiPost(t,e){return this.http.post(`${this.BASE_URL}${t}`,e).pipe(S(this.handleError))}apiDelete(t){return this.http.delete(`${this.BASE_URL}${t}`).pipe(S(e=>e.status===404?p(null):this.handleError(e)))}apiPutChannel(t,e){let r=`/channels/${t}`,i={record:{flag:"VALID",value:e}};return this.http.put(`${this.BASE_URL}${r}`,i).pipe(S(this.handleError))}handleError(t){let e="Unknown error";return t.error instanceof ErrorEvent?e=`Client Error: ${t.error.message}`:(e=`Server Error (Code: ${t.status}): ${t.message}`,t.error&&typeof t.error=="string"?e+=` - ${t.error}`:t.error&&t.error.detail&&(e+=` - ${t.error.detail}`)),console.error(e),b(()=>new Error(e))}static \u0275fac=function(e){return new(e||u)(D(M),D(G))};static \u0275prov=B({token:u,factory:u.\u0275fac,providedIn:"root"})};export{V as a};
